"use strict";(self.webpackChunkddupg_github_io=self.webpackChunkddupg_github_io||[]).push([[1477],{10:e=>{e.exports=JSON.parse('{"blogPosts":[{"id":"docusaurus-website-3","metadata":{"permalink":"/blog/docusaurus-website-3","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/docusaurus-website-3/index.md","source":"@site/blog/docusaurus-website-3/index.md","title":"Docusaurus\u5efa\u7ad9\uff083\uff09- hygen\u751f\u6210\u9875\u9762\u6a21\u7248","description":"\u5199\u535a\u5ba2\u6bcf\u6b21\u90fd\u8981\u5199\u4e00\u5806matter\u4fe1\u606f\uff0c\u8d3c\u9ebb\u70e6\uff0c\u7528hygen\u5de5\u5177\u751f\u6210\u3002","date":"2022-06-26T12:00:00.000Z","formattedDate":"2022\u5e746\u670826\u65e5","tags":[{"label":"Docusaurus","permalink":"/blog/tags/docusaurus"},{"label":"Hygen","permalink":"/blog/tags/hygen"},{"label":"\u524d\u7aef","permalink":"/blog/tags/\u524d\u7aef"}],"readingTime":1.55,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"docusaurus-website-3","title":"Docusaurus\u5efa\u7ad9\uff083\uff09- hygen\u751f\u6210\u9875\u9762\u6a21\u7248","date":"2022-06-26T12:00","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Docusaurus","Hygen","\u524d\u7aef"],"oid":"oid"},"nextItem":{"title":"Docusaurus\u5efa\u7ad9\uff082\uff09- \u90e8\u7f72\u5230GitHub Pages","permalink":"/blog/docusaurus-website-2"}},"content":"\u5199\u535a\u5ba2\u6bcf\u6b21\u90fd\u8981\u5199\u4e00\u5806matter\u4fe1\u606f\uff0c\u8d3c\u9ebb\u70e6\uff0c\u7528hygen\u5de5\u5177\u751f\u6210\u3002\\n\\n\x3c!-- truncate --\x3e\\n\\n## hygen\u4f7f\u7528\\n\\n### MacOS\u5b89\u88c5\\n\\n```bash\\n$ brew tap jondot/tap\\n$ brew install hygen\\n```\\n\\n\u5176\u4ed6\u7cfb\u7edf\u6216\u5b89\u88c5\u65b9\u5f0f\u53c2\u8003\u5b98\u7f51\u3002\\n\\n### \u521d\u59cb\u5316\u9879\u76ee\\n\\n```bash\\n$ cd your-project\\n$ hygen init self\\n```\\n\\n### \u6dfb\u52a0\u81ea\u5df1\u7684\u535a\u5ba2\u6a21\u7248\\n\\n```\\n$ hygen generator new blog\\n```\\n\\n\u4f1a\u4ea7\u751f\u4e00\u4e2a`_templates/blog/new/hello.ejs.t`\u6587\u4ef6\uff0c\u628a`hello.ejs.t`\u6539\u540d\u6210`index.ejs.t`\\n\\n```yml title=\\"_templates/blog/new/index.ejs.t\\"\\n---\\nto: blog/<%= name %>/index.md\\n---\\n---\\nslug: \\ntitle: \\ndate: <%= h.getBlogDate() %>\\nauthor: Ddupg\\nauthor_title: \u6570\u636e\u5e93\u5de5\u7a0b\u5e08\\nauthor_url: https://ddupg.github.io\\ntags: [\u6570\u636e\u5e93, \u540e\u7aef]\\n---\\n\\n\x3c!-- truncate --\x3e\\n```\\n\\n- \u6bcf\u7bc7\u535a\u5ba2\u4f1a\u751f\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u76ee\u5f55\u3002\u4e2a\u4eba\u4e60\u60ef\uff0c\u65b9\u4fbf\u5728\u540c\u76ee\u5f55\u4e0b\u653e\u56fe\u7247\u7b49\u5176\u4ed6\u8d44\u6e90\u3002\\n- slug\u548ctitle\u8bb0\u5f97\u586b\uff0c\u4e0d\u7136\u4e5f\u8dd1\u4e0d\u8d77\u6765\u3002\\n- \u5176\u4ed6\u4fe1\u606f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u60c5\u51b5\u4fee\u6539\\n- `h.getBlogDate()`\u662f\u81ea\u5b9a\u4e49\u7684\u4e00\u4e2a\u5de5\u5177\u65b9\u6cd5\uff0c\u5b9a\u4e49\u5728\u6839\u76ee\u5f55\u7684`.hygen.js`\u3002\\n\\n### .hygen.js\\n\\n\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\uff0c\u653e\u4e00\u4e2a`.hygen.js`\u6587\u4ef6\uff0c\u53ef\u4ee5\u653e\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u5de5\u5177\u65b9\u6cd5\uff0c\u6bd4\u5982\u6a21\u7248\u4e2d\u7684\u65e5\u671f\u751f\u6210\u7684\u65b9\u6cd5\u5c31\u653e\u5728\u8fd9\u91cc\\n\\n```js title=\\".hygen.js\\"\\nmodule.exports = {\\n  helpers: {\\n      getBlogDate: () => {\\n          return new Date().toISOString();\\n      }\\n  }\\n}\\n```\\n\\n### \u751f\u6210\\n\\n```\\n$ hygen blog new <blog name>\\n```\\n\u6267\u884c\u4e4b\u540e\uff0c\u5c31\u4f1a\u751f\u6210\u65b0\u7684\u535a\u5ba2\u4e86\uff0c\u6587\u4ef6\u653e\u5728`blog/<blog name>/index.md`.\\n\\n## \u53c2\u8003\\n\\n- [Hygen](https://www.hygen.io/)"},{"id":"docusaurus-website-2","metadata":{"permalink":"/blog/docusaurus-website-2","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/docusaurus-website-2/index.md","source":"@site/blog/docusaurus-website-2/index.md","title":"Docusaurus\u5efa\u7ad9\uff082\uff09- \u90e8\u7f72\u5230GitHub Pages","description":"\u90e8\u7f72\u5230GitHub Pages\u3002\u5b98\u7f51\u652f\u6301\u5f88\u591a\u79cd\u65b9\u6cd5\uff0c\u6211\u9009\u4e86GitHub Action\u3002","date":"2022-06-26T11:00:00.000Z","formattedDate":"2022\u5e746\u670826\u65e5","tags":[{"label":"Docusaurus","permalink":"/blog/tags/docusaurus"},{"label":"React","permalink":"/blog/tags/react"},{"label":"\u524d\u7aef","permalink":"/blog/tags/\u524d\u7aef"}],"readingTime":2.785,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"docusaurus-website-2","title":"Docusaurus\u5efa\u7ad9\uff082\uff09- \u90e8\u7f72\u5230GitHub Pages","date":"2022-06-26T11:00","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Docusaurus","React","\u524d\u7aef"],"oid":"oid"},"prevItem":{"title":"Docusaurus\u5efa\u7ad9\uff083\uff09- hygen\u751f\u6210\u9875\u9762\u6a21\u7248","permalink":"/blog/docusaurus-website-3"},"nextItem":{"title":"Docusaurus\u5efa\u7ad9\uff081\uff09- \u9879\u76ee\u521d\u59cb\u5316","permalink":"/blog/docusaurus-website-1"}},"content":"\u90e8\u7f72\u5230GitHub Pages\u3002\u5b98\u7f51\u652f\u6301\u5f88\u591a\u79cd\u65b9\u6cd5\uff0c\u6211\u9009\u4e86GitHub Action\u3002\\n\u6211\u6709\u51e0\u53f0\u7535\u8111\uff0c\u51e0\u5957\u5f00\u53d1\u73af\u5883\uff0c\u5982\u679c\u6bcf\u4e2a\u90fd\u914d\u4e00\u904d\u4e5f\u591f\u9ebb\u70e6\u7684\uff0c\u6bd5\u7adf\u4e0d\u662f\u4e13\u4e1a\u7684\u524d\u7aef\u3002\u7528GitHub Action\u7684\u8bdd\uff0c\u5199\u7b80\u5355\u535a\u5ba2\u6216\u8005\u6587\u6863\u76f4\u63a5push\u5230\u4ed3\u5e93\u5c31\u597d\u4e86\uff0c\u751a\u81f3\u53ef\u4ee5\u5728GitHub\u7684\u7f51\u9875\u7f16\u8f91\uff0c\u65b9\u4fbf\u5f97\u5f88\u3002\\n\\n\x3c!-- truncate --\x3e\\n\\n## \u65b0\u5efaGitHub\u4ed3\u5e93&\u4e0a\u4f20\u4ee3\u7801\\n\\n\u4e0a\u4e00\u6b65\u53ea\u80fd\u5728\u672c\u5730\u8fd0\u884c\u90e8\u7f72\uff0c\u8981\u628a\u5b83\u90e8\u7f72\u5230GitHub Pages\uff0c\u5f97\u5148\u4e0a\u4f20\u5230GitHub\u7684\u4e00\u4e2a\u4ed3\u5e93\u91cc\u3002\\n\\n\u6211\u8fd9\u91cc\u5c31\u662f\u4e0a\u4f20\u5230\u4e86ddupg.github.io\u4ed3\u5e93\u3002\\n\\n> \u4ee5github.io\u540e\u7f00\u7684\u4ed3\u5e93\u540d\uff0cGitHub\u4f1a\u9ed8\u8ba4\u8fd9\u662f\u4e2aGitHub Pages\u9879\u76ee\uff0c\u5982\u679c\u662f\u5176\u4ed6\u9879\u76ee\u8fd8\u9700\u8981\u81ea\u5df1\u914d\u7f6eGitHub Pages\u3002\u5177\u4f53\u770b\u4e0b[\u5b98\u7f51\u4ecb\u7ecd](https://pages.github.com/)\u3002\\n\\n## \u914d\u7f6eAccess Token\\n\\n### \u751f\u6210\\n\\n\u751f\u6210\u4e00\u4e2a\u4e13\u7528\u4e8eGitHub Pages\u90e8\u7f72\u7528\u7684access token\uff0cGitHub Action\u9700\u8981\u7528\u8fd9\u4e2atoken\u624d\u80fd\u90e8\u7f72\u3002\\n\\n\u5728\u81ea\u5df1\u7684GitHub\u8d26\u53f7\u91cc\uff0c\u4ece\u9875\u9762\u53f3\u4e0a\u89d2\u5f00\u59cb\uff1a\\n\\n*Setting ->Developer settings ->  Personal access tokens*\\n\\n\u751f\u6210\u4e00\u4e2a\u65b0\u7684token\uff0c\u8bb0\u5f97\u590d\u5236\u4e0b\u6765\uff0c\u9a6c\u4e0a\u8981\u7528\uff1a\\n\\n![new-token.png](new-token.png)\\n\\n### \u914d\u7f6e\\n\\n![](env-var.png)\\n\\n\u8fd9\u91cc\u7684\u73af\u5883\u53d8\u91cf\u540d\u540e\u9762\u8981\u7528\uff0c\u4e0d\u8981\u4e71\u8d77\u540d\u3002\u73af\u5883\u53d8\u91cf\u7684\u503c\uff0c\u5c31\u662f\u4e0a\u4e00\u6b65\u751f\u6210\u7684token\u3002\\n\\n## \u914d\u7f6eGitHub Action\\n\\n\u8be6\u7ec6\u7684\u53ef\u4ee5\u770b[Docusaurus\u6587\u6863](https://www.docusaurus.cn/docs/deployment#triggering-deployment-with-github-actions)\\n\\n\u914d\u7f6eGitHub Action\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u81ea\u5df1\u7684\u9879\u76ee\u7684\u56fa\u5b9a\u76ee\u5f55\u65b0\u52a0\u4e2a\u914d\u7f6e\u6587\u4ef6\u5c31\u597d\u4e86\u3002\\n\\n- \u6587\u4ef6\u540d\u968f\u610f\u3002\u76ee\u5f55\u5fc5\u987b\u662f\uff1a`.github/workflows/`\\n\\n- \u5982\u679c\u4f60\u7684\u9ed8\u8ba4\u4e3b\u5206\u652f\u4e0d\u662fmain\uff0c\u90a3\u5c31\u6539\u4e0b`on.push.branches`\u3002\u5982\u679c\u5176\u4ed6\u5206\u652f\u4e5f\u9700\u8981\u89e6\u53d1\uff0c\u90a3\u4e5f\u52a0\u4e0a\u5206\u652f\u540d\u3002\\n\\n- \u5982\u679c\u4f60\u7684\u73af\u5883\u53d8\u91cf\u540d\u5b57\u4e0d\u662f`ACCESS_TOKEN`\uff0c\u5c31\u6539\u4e2a\u73af\u5883\u53d8\u91cf\u540d\uff0c\u5176\u4ed6\u7684\u4e0d\u8981\u52a8\\n\\n```yml title=\\".github/workflows/ci.yml\\"\\nname: Deploy to GitHub Pages\\n\\non:\\n  push:\\n    branches:\\n      - main\\n\\njobs:\\n  deploy:\\n    name: Deploy to GitHub Pages\\n    runs-on: ubuntu-latest\\n    steps:\\n      - uses: actions/checkout@v2\\n      - uses: actions/setup-node@v3\\n        with:\\n          node-version: 16.x\\n          cache: yarn\\n\\n      - name: Install dependencies\\n        run: yarn install --frozen-lockfile\\n      - name: Build website\\n        run: yarn build\\n\\n      # Popular action to deploy to GitHub Pages:\\n      # Docs: https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-docusaurus\\n      - name: Deploy to GitHub Pages\\n        uses: peaceiris/actions-gh-pages@v3\\n        with:\\n          github_token: ${{ secrets.ACCESS_TOKEN }}\\n          # Build output to publish to the `gh-pages` branch:\\n          publish_dir: ./build\\n```\\n\\n## \u6700\u540e\\n\\n\u628a\u4fee\u6539\u540e\u7684\u914d\u7f6e\u6587\u4ef6push\u5230\u4ed3\u5e93\u5c31\u597d\u4e86\uff0cGitHub Action\u4f1a\u81ea\u52a8\u89e6\u53d1\u3002\\n\\n\u518d\u4fee\u6539\u4e0bGitHub Pages\u4f7f\u7528\u7684\u5206\u652f\uff0c\u8fd9\u4e8b\u5c31\u6210\u4e86\u3002\\n\\n![](github-pages.png)\\n\\n## \u53c2\u8003\\n\\n[Docusaurus\u6587\u6863](https://www.docusaurus.cn/)"},{"id":"docusaurus-website-1","metadata":{"permalink":"/blog/docusaurus-website-1","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/docusaurus-website-1/index.md","source":"@site/blog/docusaurus-website-1/index.md","title":"Docusaurus\u5efa\u7ad9\uff081\uff09- \u9879\u76ee\u521d\u59cb\u5316","description":"\u672c\u60f3\u91cd\u505a\u81ea\u5df1\u7684\u535a\u5ba2\u548c\u6587\u6863\uff0c\u672c\u6253\u7b97\u4ece\u5934\u5199\uff0c\u8c03\u7814\u4e86Next.js\u548cGatsby\uff0c\u90fd\u662f\u5f88\u5f3a\u5927\u7684\u6846\u67b6\uff0c\u4f46\u5bf9\u6211\u4e2a\u540e\u7aef\u5f00\u53d1\u6765\u8bf4\u8fd8\u662f\u5f88\u6709\u96be\u5ea6\u7684\u3002\u65e0\u610f\u4e2d\u770b\u5230\u4e86Docusaurus\u6846\u67b6\uff0c\u80fd\u81ea\u5e26\u6587\u6863\u548c\u535a\u5ba2\uff0c\u8fd8\u80fd\u9ad8\u5ea6\u81ea\u5b9a\u4e49\u9875\u9762\uff0c\u5b8c\u7f8e\u5339\u914d\u6211\u7684\u9700\u6c42\uff0c\u6240\u4ee5\u5c31\u6709\u4e86\u8fd9\u4e2a\u7cfb\u5217\uff0c\u6253\u7b97\u8bb0\u5f55\u4e0b\u6574\u4e2a\u535a\u5ba2\u6539\u9020\u8fc7\u7a0b\uff0c\u80fd\u5199\u51e0\u671f\u4e0d\u4e00\u5b9a\uff0c\u6162\u6162\u6765\u5427\u3002","date":"2022-06-26T10:00:00.000Z","formattedDate":"2022\u5e746\u670826\u65e5","tags":[{"label":"Docusaurus","permalink":"/blog/tags/docusaurus"},{"label":"React","permalink":"/blog/tags/react"},{"label":"\u524d\u7aef","permalink":"/blog/tags/\u524d\u7aef"}],"readingTime":1.45,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"docusaurus-website-1","title":"Docusaurus\u5efa\u7ad9\uff081\uff09- \u9879\u76ee\u521d\u59cb\u5316","date":"2022-06-26T10:00","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Docusaurus","React","\u524d\u7aef"],"oid":"oid"},"prevItem":{"title":"Docusaurus\u5efa\u7ad9\uff082\uff09- \u90e8\u7f72\u5230GitHub Pages","permalink":"/blog/docusaurus-website-2"},"nextItem":{"title":"\u521d\u5c1dGatsby","permalink":"/blog/first-try-gatsby"}},"content":"\u672c\u60f3\u91cd\u505a\u81ea\u5df1\u7684\u535a\u5ba2\u548c\u6587\u6863\uff0c\u672c\u6253\u7b97\u4ece\u5934\u5199\uff0c\u8c03\u7814\u4e86Next.js\u548cGatsby\uff0c\u90fd\u662f\u5f88\u5f3a\u5927\u7684\u6846\u67b6\uff0c\u4f46\u5bf9\u6211\u4e2a\u540e\u7aef\u5f00\u53d1\u6765\u8bf4\u8fd8\u662f\u5f88\u6709\u96be\u5ea6\u7684\u3002\u65e0\u610f\u4e2d\u770b\u5230\u4e86Docusaurus\u6846\u67b6\uff0c\u80fd\u81ea\u5e26\u6587\u6863\u548c\u535a\u5ba2\uff0c\u8fd8\u80fd\u9ad8\u5ea6\u81ea\u5b9a\u4e49\u9875\u9762\uff0c\u5b8c\u7f8e\u5339\u914d\u6211\u7684\u9700\u6c42\uff0c\u6240\u4ee5\u5c31\u6709\u4e86\u8fd9\u4e2a\u7cfb\u5217\uff0c\u6253\u7b97\u8bb0\u5f55\u4e0b\u6574\u4e2a\u535a\u5ba2\u6539\u9020\u8fc7\u7a0b\uff0c\u80fd\u5199\u51e0\u671f\u4e0d\u4e00\u5b9a\uff0c\u6162\u6162\u6765\u5427\u3002\\n\\n\x3c!-- truncate --\x3e\\n\\n## \u521d\u59cb\u5316\u9879\u76ee\\n\\n```\\n$ npx create-docusaurus@latest my-website classic --typescript\\n```\\n\\n```\\n$ yarn\\n$ yarn build\\n$ yarn start # \u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u80fd\u81ea\u52a8\u5237\u65b0\\n$ yarn serve # \u4e0d\u4f1a\u81ea\u52a8\u5237\u65b0\\n```\\n\\n## \u4fee\u6539\u7f51\u7ad9\u914d\u7f6e\\n\\n### \u4fee\u6539\u7f51\u7ad9\u57fa\u672c\u4fe1\u606f\\n\\n![config-basic.png](./config-basic.png)\\n\\n### \u4fee\u6539\u56fe\u6807&\u5bfc\u822a\u680f\\n\\n![](./config-navbar.png)\\n\\n\u5236\u4f5c\u56fe\u6807\u8fc7\u7a0b\u4e2d\u7528\u5230\u7684\u51e0\u4e2a\u5de5\u5177\uff0c\u90fd\u662f\u4e34\u65f6google\u627e\u7684\uff1a\\n\\n[\u56fe\u7247\u80cc\u666f\u6d88\u9664](https://www.remove.bg/zh)\\n\\n[icon\u56fe\u6807\u751f\u6210\u5de5\u5177](https://www.logosc.cn/logo/favicon?s=d)\\n\\n[PNG\u8f6cSVG - \u5728\u7ebf\u8f6c\u6362\u56fe\u50cf\u6587\u4ef6](https://www.aconvert.com/cn/image/png-to-svg/)\\n\\n### \u4fee\u6539Footer\\n\\n![](./config-footer.png) \xa0\\n\\n## \u5220\u6389\u81ea\u5e26\u7684\u535a\u5ba2/\u6587\u6863Demo\\n\\n\u535a\u5ba2\u76ee\u5f55\uff1a`blog/`\\n\u6587\u6863\u76ee\u5f55\uff1a`docs/`\\n\\n\u6587\u6863\u76ee\u5f55\u53ea\u7559\u4e2a`intro.md`\uff0c\u56e0\u4e3a\u914d\u7f6e\u91cc\u7559\u4e86\u8fd9\u4e2a\u6587\u4ef6\u7684\u5f15\u7528\uff0c\u540e\u9762\u5f53\u4e2a\u4e3b\u9875\u5bfc\u822a\u7528\u3002"},{"id":"first-try-gatsby","metadata":{"permalink":"/blog/first-try-gatsby","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/first-try-gatsby/index.md","source":"@site/blog/first-try-gatsby/index.md","title":"\u521d\u5c1dGatsby","description":"\u7b2c\u4e00\u6b21\u4f53\u9a8cGatsby\u9879\u76ee\uff0c\u521b\u5efademo\u9879\u76ee\u5c31\u78b0\u5230\u4e86\u4e0d\u5c11\u95ee\u9898\u3002","date":"2022-06-18T08:11:00.000Z","formattedDate":"2022\u5e746\u670818\u65e5","tags":[{"label":"Gatsby","permalink":"/blog/tags/gatsby"},{"label":"React","permalink":"/blog/tags/react"},{"label":"\u524d\u7aef","permalink":"/blog/tags/\u524d\u7aef"}],"readingTime":2.2,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"first-try-gatsby","title":"\u521d\u5c1dGatsby","date":"2022-06-18T08:11","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Gatsby","React","\u524d\u7aef"]},"prevItem":{"title":"Docusaurus\u5efa\u7ad9\uff081\uff09- \u9879\u76ee\u521d\u59cb\u5316","permalink":"/blog/docusaurus-website-1"},"nextItem":{"title":"HBase SCP & TRSP","permalink":"/blog/HBase-SCP-and-TRSP"}},"content":"\u7b2c\u4e00\u6b21\u4f53\u9a8cGatsby\u9879\u76ee\uff0c\u521b\u5efademo\u9879\u76ee\u5c31\u78b0\u5230\u4e86\u4e0d\u5c11\u95ee\u9898\u3002\\n\u7b14\u8005\u7528\u7684\u662fMacOS\u73af\u5883\u3002\\n\\n\x3c!-- truncate --\x3e\\n\\n## sharp\u95ee\u9898\\n\\n```\\n\u276f Installing Gatsby...\\n\\nnpm ERR! code 1\\nnpm ERR! path /Users/ddupg/github/gatsby-demo/node_modules/sharp\\nnpm ERR! command failed\\nnpm ERR! command sh -c (node install/libvips && node install/dll-copy && prebuild-install) || (node install/can-compile && node-gyp rebuild && node install/dll-copy)\\nnpm ERR! sharp: Downloading https://github.com/lovell/sharp-libvips/releases/download/v8.12.2/libvips-8.12.2-darwin-x64.tar.br\\nnpm ERR! sharp: Please see https://sharp.pixelplumbing.com/install for required dependencies\\nnpm ERR! sharp: Installation error: connect ETIMEDOUT 185.199.111.133:443\\n\\nnpm ERR! A complete log of this run can be found in:\\n\\n ERROR\\n\\nCommand failed with exit code 1: npm install --loglevel error --color always\\n```\\n \\n\u53c2\u8003[\u89e3\u51b3gatsby\u5b89\u88c5\u5931\u8d25sharp: Command failed](https://juejin.cn/post/6844903856464199687)\\n\u8fd9\u662f\u56fd\u5185\u8fde\u63a5github\u7f51\u7edc\u4e0d\u7a33\uff0c\u4f9d\u8d56\u8d44\u6e90\u4e0b\u8f7d\u4e0d\u4e86\u3002\\n\u4ece\u5f02\u5e38\u4e2d\u80fd\u770b\u51fa\u4f9d\u9700\u8981\u4e0b\u8f7d\u7684\u5177\u4f53\u5305\uff0c\u6211\u8fd9\u91cc\u5c31\u662f**libvips-8.12.2-darwin-x64.tar.br**\uff0c\u624b\u52a8\u4ece[github](https://github.com/lovell/sharp-libvips/releases)\u4e0b\u8f7d\u5bf9\u5e94\u7248\u672c\uff0c\u653e\u5230`~/.npm/_libvips`\\n\u76ee\u5f55\uff0c\u518d\u5c1d\u8bd5\u5c31\u597d\u4e86\u3002\\n\\n## vips\u95ee\u9898\\n\\n```\\n\u276f Installing Gatsby...\\n\\nnpm ERR! code 1\\nnpm ERR! path /Users/ddupg/github/my-gatsby-site/node_modules/sharp\\nnpm ERR! command failed\\nnpm ERR! command sh -c (node install/libvips && node install/dll-copy && prebuild-install) || (node install/can-compile && node-gyp rebuild && node install/dll-copy)\\nnpm ERR! sharp: Using cached /Users/ddupg/.npm/_libvips/libvips-8.12.2-darwin-x64.tar.br\\nnpm ERR! sharp: Integrity check passed for darwin-x64\\nnpm ERR!   TOUCH Release/obj.target/libvips-cpp.stamp\\nnpm ERR!   CC(target) Release/obj.target/nothing/node_modules/node-addon-api/nothing.o\\nnpm ERR!   LIBTOOL-STATIC Release/nothing.a\\nnpm ERR!   CXX(target) Release/obj.target/sharp-darwin-x64/src/common.o\\nnpm ERR! ../src/common.cc:24:10: fatal error: \'vips/vips8\' file not found\\nnpm ERR! #include <vips/vips8>\\nnpm ERR!          ^~~~~~~~~~~~\\nnpm ERR! 1 error generated.\\nnpm ERR! make: *** [Release/obj.target/sharp-darwin-x64/src/common.o] Error 1\\nnpm ERR! gyp ERR! build error\\nnpm ERR! gyp ERR! stack Error: `make` failed with exit code: 2\\nnpm ERR! gyp ERR! stack     at ChildProcess.onExit (/Users/ddupg/.node_global/lib/node_modules/npm/node_modules/node-gyp/lib/build.js:194:23)\\nnpm ERR! gyp ERR! stack     at ChildProcess.emit (node:events:526:28)\\nnpm ERR! gyp ERR! stack     at Process.ChildProcess._handle.onexit (node:internal/child_process:291:12)\\nnpm ERR! gyp ERR! System Darwin 19.3.0\\nnpm ERR! gyp ERR! command \\"/usr/local/bin/node\\" \\"/Users/ddupg/.node_global/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js\\" \\"rebuild\\"\\nnpm ERR! gyp ERR! cwd /Users/ddupg/github/my-gatsby-site/node_modules/sharp\\nnpm ERR! gyp ERR! node -v v16.14.2\\nnpm ERR! gyp ERR! node-gyp -v v9.0.0\\nnpm ERR! gyp ERR! not ok\\n\\nnpm ERR! A complete log of this run can be found in:\\n\\n ERROR\\n\\nCommand failed with exit code 1: npm install --loglevel error --color always\\n```\\n\\n\u53c2\u8003[vips/vips8 file not found #include <vips/vips8> in Ionic cordova in IOS](https://stackoverflow.com/questions/66363572/vips-vips8-file-not-found-include-vips-vips8-in-ionic-cordova-in-ios)\\n\u624b\u52a8\u5b89\u88c5vips\\n```\\nbrew install vips\\n```\\n\\n## \u5176\u4ed6\\n\u56fd\u5185\u73af\u5883brew\u4e0b\u8f7d\u8d3c\u6162\uff0c\u53c2\u8003[brew\u6362\u6e90](https://zhuanlan.zhihu.com/p/324691527)"},{"id":"HBase-SCP-and-TRSP","metadata":{"permalink":"/blog/HBase-SCP-and-TRSP","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/HBase-SCP-and-TRSP/index.md","source":"@site/blog/HBase-SCP-and-TRSP/index.md","title":"HBase SCP & TRSP","description":"\u6700\u8fd1\u5728\u7ec4\u5185\u8fdb\u884c\u7684\u4e00\u6b21SCP\u548cTRSP\u4e24\u4e2aProcedure\u6267\u884c\u8fc7\u7a0b\u7684\u5206\u4eab\uff0c\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e00\u4e0b\uff0c\u61d2\u5f97\u53bb\u6574\u7406\u51fa\u6587\u7ae0\u4e86","date":"2020-04-16T15:20:00.000Z","formattedDate":"2020\u5e744\u670816\u65e5","tags":[{"label":"HBase","permalink":"/blog/tags/h-base"}],"readingTime":12.7,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"HBase-SCP-and-TRSP","title":"HBase SCP & TRSP","date":"2020-04-16T15:20","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["HBase"]},"prevItem":{"title":"\u521d\u5c1dGatsby","permalink":"/blog/first-try-gatsby"},"nextItem":{"title":"HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","permalink":"/blog/HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb"}},"content":"\u6700\u8fd1\u5728\u7ec4\u5185\u8fdb\u884c\u7684\u4e00\u6b21SCP\u548cTRSP\u4e24\u4e2aProcedure\u6267\u884c\u8fc7\u7a0b\u7684\u5206\u4eab\uff0c\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e00\u4e0b\uff0c\u61d2\u5f97\u53bb\u6574\u7406\u51fa\u6587\u7ae0\u4e86 :stuck_out_tongue_winking_eye:\\n\\n\x3c!-- truncate --\x3e\\n\\n\\n## AMv2\\n\\n### \u6bd4\u8f83\u91cd\u8981\u7684\u7c7b\\n\\n![AMv2\u4e3b\u8981\u7684\u7c7b](amv2.png)\\n\\n#### AssignmentManager\\n\\n\u7ba1\u7406Region\u7684assign/unassign\u64cd\u4f5c\uff0c\u7ba1\u7406Region\u7684\u72b6\u6001\u4fe1\u606f\u3002\\n\\n\u5176\u4e2d\u4e3b\u8981\u5c5e\u6027\uff1a\\n- RegionStates: \u7ba1\u7406\u5185\u5b58\u4e2d\u7684Region\u72b6\u6001\u4fe1\u606f\uff0cRS\u4e0a\u6709\u54ea\u4e9bregion\\n- RegionStateStore: \u64cd\u4f5cmeta\u8868\\n\\n#### RegionStateNode\\n\\n- lock: \u5bf9Region\u72b6\u6001\u4fe1\u606f\u548cRegionLoacation\u4fe1\u606f\u52a0\u9501\uff0c\u9632\u6b62\u5e76\u53d1\u4fee\u6539\u3002\\n- regionInfo: Region\u4fe1\u606f\\n- event: \u7528\u4e8e\u591a\u4e2aprocedure\u7b49\u5f85Region\u7684\u67d0\u4e2a\u72b6\u6001\u53d8\u5316\uff0c\u6bd4\u5982open\u3001close\u3002\\n- procedure: \u8bb0\u5f55\u552f\u4e00\u7ed1\u5b9a\u7684TRSP\uff0c\u4fdd\u8bc1\u6bcf\u4e2aRegion\u53ea\u80fd\u540c\u65f6\u8fdb\u884c\u4e00\u4e2aTRSP\u3002\\n- regionLocation: region\u8981\u88abassign\u5230\u54ea\u4e2aRS\u3002\\n\\n#### ProcedureEvent\\n\\n\u7528\u4e8e\u591a\u4e2aProcedure\u7b49\u5f85\u67d0\u4e2a\u4f9d\u8d56\u7684\u4e8b\u4ef6\uff0c\u5728AMv2\u4e2d\uff0c\u4e3b\u8981\u7684\u5c31\u662f\u7b49\u5f85Region\u7684\u72b6\u6001\u53d8\u5316\u3002\\n\\n![ProcedureEvent](ProcedureEvent.png)\\n\\n\u4e8b\u4ef6\u72b6\u6001\u5c31\u4e24\u79cd\uff1a\\n- ready: \u67d0\u4e2a\u4e8b\u4ef6\u5df2\u51c6\u5907\u597d\uff0c\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\\n- suspend: \u4e8b\u4ef6\u672a\u51c6\u5907\u597d\uff0c\u4e4b\u540e\u8c03\u7528suspendIfNotReady()\u65b9\u6cd5\u7684Procedure\u90fd\u4f1a\u88ab\u52a0\u5230 suspendedProcedure\u961f\u5217\u91cc\uff0c\u7528\u4e8e\u4e4b\u540e\u5524\u9192\u3002\\n\\n\u4e3b\u8981\u65b9\u6cd5\uff1a\\n- suspendIfNotReady: \u5982\u679c\u662fready\u72b6\u6001\uff0c\u8868\u793a\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\uff1b\u5982\u679csuspend\u72b6\u6001\uff0cProcedure\u4f1a\u88ab\u52a0\u5230 suspendedProcedure\u961f\u5217\u91cc\uff0c\u7528\u4e8e\u4e4b\u540e\u5524\u9192\u3002\u8fd9\u65f6\u5019Procedure\u4f1a\u629b\u51faProcedureSuspendedException\uff0cPv2\u6846\u67b6\u4f1a\u6682\u505cProcedure\u7684\u6267\u884c\uff0c\u7b49\u5f85\u88ab\u5524\u9192\u3002\\n\\n\u8fd9\u4e2a\u529f\u80fd\u6709\u4e2a\u95ee\u9898\u5c31\u662f\u53ea\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u65e0\u6cd5\u6062\u590d\uff0c\u5982\u679cProcedure\u4f7f\u7528\u4e0d\u597d\uff0cMaster\u91cd\u542f\uff0c\u7b49\u5f85\u961f\u5217\u65e0\u6cd5\u6062\u590d\uff0cProcedure\u53ef\u80fd\u6c38\u8fdc\u65e0\u6cd5\u88ab\u5524\u9192\u3002\\n\\n## ServerCrashProcedure\\n\\n### \u89e6\u53d1\u6761\u4ef6\\n\\n#### zk session expire\uff08\u88ab\u52a8\u89e6\u53d1\uff09\\n\\n\u76d1\u542czk\u4e0ars\u8282\u70b9\u7684\u53d8\u5316\uff0c\u5982\u679c\u4ee3\u8868\u67d0\u4e2ars\u7684\u5b50\u8282\u70b9\u88ab\u8fc7\u671f\u5220\u9664\uff0c\u5c31\u89e6\u53d1SCP\u3002\\n\\n\u914d\u7f6e: {zookeeper.znode.parent}/{zookeeper.znode.rs}/\\n\\n\u9ed8\u8ba4: /hbase/{cluster name}/rs/\\n\\n\u6b64\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679crs\u5904\u4e8e\u975eONLINE\u72b6\u6001\uff0c\u4e0d\u4f1a\u5f3a\u5236\u6267\u884cServerCrashProcedure\\n\\n#### HBCK2 \uff08\u4e3b\u52a8\u89e6\u53d1\uff09\\n\\n\u8981\u4f7f\u7528\u5b8c\u6574\u7684ServerName\uff0c\u5305\u542b\u540e\u9762\u7684startcode\u3002\\n\\n```\\n./hbase hbck -j hbase-hbck2-1.0.0-SNAPSHOT.jar scheduleRecoveries c4-hadoop-tst-st84.bj,55600,1586416554312 c4-hadoop-tst-st85.bj,55600,1586415546993\\n```\\n\\n\u65e0\u8bbars\u662f\u5426\u5904\u4e8eONLINE\u72b6\u6001\uff0c\u90fd\u4f1a\u5f3a\u5236\u6267\u884c HBCKServerCrashProcedure\uff08ServerCrashProcedure\u7684\u5b50\u7c7b\uff09\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u884c\u4e3a\u548cServerCrashProcedure\u4e00\u6837\uff0c\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8egetRegionsOnCrashedServer\u65b9\u6cd5\uff1a\\n\\n\u5982\u679cServerCrashProcedure.getRegionsOnCrashedServer\u8fd4\u56de\u7a7a\u96c6\u5408\uff0cHBCKServerCarshProcedure\u4f1ascan\u8bfbmeta\u8868\uff0c\u5c06meta\u8868\u4e0a\u8bb0\u5f55\u7684Opening\u548cOpened\u4e24\u79cd\u72b6\u6001\u7684region\u8fd4\u56de\uff0c\u53e6\u5916\u5c06Closing\u72b6\u6001\u7684region\u6539\u4e3aClose\u3002\\n\\n### \u72b6\u6001\u53d8\u5316\\n\\n**\u51c6\u5907\u5de5\u4f5c**\\n\\n\u5c06\u5f53\u524d\u5904\u7406\u7684rs\u52a0\u5230 DeadServer processing list\u3002\u5728SCP\u6267\u884c\u7ed3\u675f\u4e4b\u540e\uff0c\u624d\u52a0\u5230 DeadServers list\u3002\u6bcf\u4e2a\u72b6\u6001\u90fd\u4f1a\u68c0\u67e5\u4e0b\uff0c\u662f\u5426\u52a0\u8fdb\u53bb\u4e86\u3002\\n\\n**\u7b49\u5f85meta\u8868\u53ef\u7528**\\n\\n```\\ncase SERVER_CRASH_START:\\ncase SERVER_CRASH_SPLIT_META_LOGS:\\ncase SERVER_CRASH_DELETE_SPLIT_META_WALS_DIR:\\ncase SERVER_CRASH_ASSIGN_META:\\nbreak;\\ndefault:\\n// If hbase:meta is not assigned, yield.\\nif (env.getAssignmentManager().waitMetaLoaded(this)) {\\n    throw new ProcedureSuspendedException();\\n}\\n```\\n\\n\u524d\u9762\u51e0\u4e2a\u72b6\u6001\u90fd\u662f\u64cd\u4f5cmeta\u8868\u7684region\u7684\u72b6\u6001\uff0c\u6240\u4ee5meta\u8868\u4e0d\u53ef\u7528\u4e5f\u4f1a\u6267\u884c\uff0c\u5176\u4ed6\u7684\u72b6\u6001\u4f1a\u64cd\u4f5c\u666e\u901aregion\uff0c\u6d89\u53ca\u5230meta\u8868\u7684\u8bfb\u5199\uff0c\u6240\u4ee5\u5176\u4ed6\u72b6\u6001\u90fd\u8981\u6c42meta\u8868\u7684region\u53ef\u7528\uff0c\u624d\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u3002\u8fd9\u91cc\u5c31\u5229\u7528\u4e86ProcedureEvent\u8fd9\u4e2a\u7c7b\u7684\u529f\u80fd\uff0c\u7b49\u5f85meta region\u52a0\u8f7d\u5b8c\u6210\u4e4b\u540e\u624d\u5141\u8bb8\u7ee7\u7eed\u4e0b\u9762\u7684\u72b6\u6001\uff0c\u5426\u5219\u76f4\u63a5\u629b\u51faProcedureSuspendedException\u6682\u505c\u5f53\u524dProcedure\u7684\u6267\u884c\uff0c\u7b49\u5f85\u88ab\u5524\u9192\u3002\\n\\n**\u4f46\u8fd9\u91cc\u597d\u50cf\u4f7f\u7528AssignmentManager.metaAssignEvent\u66f4\u5408\u9002**\u3002\u56e0\u4e3ameatLoadedEvent\u53ea\u6709\u5728Master\u542f\u52a8\u4e4b\u540e\u624d\u4f1a\u89e6\u53d1\u4e00\u6b21\uff0cmetaAssignEvent\u5728Master\u542f\u52a8\u548c\u6bcf\u6b21meta region open\u90fd\u4f1a\u89e6\u53d1\uff0c\u6240\u4ee5metaAssignEvent\u6765\u4ee3\u8868meta region\u53ef\u7528\u66f4\u5408\u9002\u4e00\u4e9b\u3002\\n\\n![SCP\u6d41\u7a0b\u56fe](SCP.png)\\n\\n- \\bSTART: \u6ca1\u6709\u4ec0\u4e48\u5b9e\u9645\u64cd\u4f5c\uff0c\u6839\u636eRS\u4e0a\u662f\u5426\u6709meta\u8868\u7684region\uff0c\u6765\u5224\u65ad\u4e0b\u4e00\u6b65\u7684\u72b6\u6001\\n- SPLIT_META_LOGS: split meta\u8868\u7684WAL\\n- DELETE_SPLIT_META_WALS_DIR: \u5220\u9664HDFS\u4e0ameta\u8868split log\u7684\u76ee\u5f55\\n- ASSIGN_META: \u91cd\u65b0assign meta region\\n- GET_REGIONS: \u67e5\u8be2RS\u4e0a\u9664meta\u5916\u7684region\\n- SPLIT_LOGS: split\u975emeta\u8868\u7684WAL\\n- DELETE_SPLIT_WALS_DIR: \u5220\u9664HDFS\u4e0a\u975emeta\u8868\u7684WAL\u76ee\u5f55\\n- ASSIGN: assign \u975emeta\u7684region\\n- FINISH: \u6536\u5c3e\u5de5\u4f5c\uff0c\u5c06RS\u52a0\u5230 DeadServers list\uff0c\u89e6\u53d1CP\\n\\n\u5176\u5b9e\u8fd9\u4e9b\u72b6\u6001\u4e3b\u8981\u53ef\u4ee5\u505a\u7684\u5c31\u662fSplit WAL\uff0cDelete WAL dir\uff0cAssign region\u8fd9\u4e09\u7c7b\uff0c\u53ea\u4e0d\u8fc7\u5c06Region\u6309\u662f\u5426\u662fmeta\u505a\u4e86\u533a\u5206\uff0cmeta region\u548c\u666e\u901aregion\u5206\u522b\u505a\u4e86\u8fd9\u4e09\u7c7b\u64cd\u4f5c\u3002\u8fd9\u91cc\u6211\u7406\u89e3\u539f\u56e0\u5e94\u8be5\u662f\u666e\u901a\u7684region assign\u9700\u8981\u8bfb\u5199meta\u8868\uff0c\u6240\u4ee5\u8981\u6c42meta\u8868\u7684region\u5fc5\u987b\u53ef\u7528\u624d\u884c\uff0c\u6240\u4ee5\u4f18\u5148\u5bf9meta region\u8fdb\u884c\u4e09\u6b65\u64cd\u4f5c\u5904\u7406\uff0cmeta region\u53ef\u7528\u4e4b\u540e\u624d\u4f1a\u8fdb\u884c\u666e\u901aregion\u7684\u4e09\u6b65\u64cd\u4f5c\u3002\\n\\n### \u95ee\u9898\\n\\n**\u6267\u884cSCP\u7684\u65f6\u5019\uff0cRS\u4e0a\u7684region\u662f\u600e\u4e48\u5904\u7406\u7684\uff1f**\\n\\n\u76f4\u63a5\u7f6e\u4e3aABNORMALLY_CLOSED\uff0c\u8ba4\u4e3a\u6240\u6709\u7684region\u90fd\u5df2\u7ecf\u4e0d\u53ef\u7528\u4e86\u3002\\n\\n\u5982\u679cregion\u6709TRSP\u5728\u8fdb\u884c\uff0c\u5c31\u8fdb\u4e00\u6b65\u901a\u77e5\u6240\u6709\u8fd9\u4e9bregion\u7684TRSP\u548cRRP\uff0c\u505a\u5bf9\u5e94\u7684\u64cd\u4f5c\u3002\\n\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u65b0\u52a0TRSP\u53bbassign\u8fd9\u4e9bregion\u3002\\n\\n\u5982\u679crs\u518d\u6062\u590d\u6216\u542f\u52a8\u7684\u8bdd\uff0c\u4e5f\u5e94\u8be5\u4f1a\u53d1\u73b0zk\u7684\u8282\u70b9\u4e22\u4e86\uff0c\u4e0d\u80fd\u76f4\u63a5open\u5b83\u7684region\u3002\uff08\u8fd9\u4e2a\u6ca1\u6709\u53bb\u770b\u4ee3\u7801\u786e\u8ba4\uff09\\n\\n## TransitRegionStateProcedure\\n\\n### \u4e3b\u8981\u53d8\u91cf\\n\\n**type/initialState/lastState**\\n\\n| type | initialState | lastState |\\n| --- | --- | --- |\\n| ASSIGN | GET_ASSIGN_CANDIDATE | CONFIRM_OPENED |\\n| UNASSIGN | CLOSE |  CONFIRM_CLOSED |\\n| MOVE | CLOSE | CONFIRM_OPENED |\\n| REOPEN | CLOSE | CONFIRM_OPENED |\\n\\n\\n**remoteProc**\\n\\n\u7ed1\u5b9a\u7684\u67d0\u4e2aRegionRemoteProcedureBase\uff0c\u7528\u4e8e\u6267\u884copen/close region\u8fd9\u6837\u7684RPC\u64cd\u4f5c\uff0c\u8fd9\u91cc\u4e5f\u53ea\u80fd\u6709\u4e00\u4e2aremoteProc\uff0c\u8868\u793a\u4e0d\u80fd\u540c\u65f6\u8fdb\u884c\u591a\u4e2a\u64cd\u4f5cregion\u72b6\u6001\u7684RPC\u3002\\n\\n### \u72b6\u6001\u6d41\u8f6c\\n\\n![TRSP\u72b6\u6001\u7b80\u56fe](TRSP-simple.png)\\n\\n\u53ef\u4ee5\u770b\u51fa\u6765\uff0cTRSP\u4e2d\u76845\u4e2a\u72b6\u6001\u5f62\u6210\u4e00\u4e2a\u73af\uff0c\u901a\u8fc7initialState\u548clastState\u4e24\u4e2a\u72b6\u6001\u5224\u65ad\u5165\u73af\u548c\u51fa\u73af\u7684\u72b6\u6001\u3002\\n\\n\u50cfASSIGN\u548cUNASSIGN\u4e24\u4e2a\u64cd\u4f5c\uff0c\u53ea\u9700\u8981\u8dd1\u5b8c\u81ea\u5df1\u7684\u72b6\u6001\u5c31\u884c\u4e86\u3002MOVE/REOPEN\u64cd\u4f5c\u5219\u8981\u5148close\u7136\u540eopen\uff0c\u4e0d\u540c\u7684\u662f\uff0c\u901a\u8fc7\u6307\u5b9aRegionStateNode.regionLocation\u6765\u6307\u5b9aopen\u5728\u54ea\u4e2aRS\u4e0a\uff0copen\u7684rs\u53d8\u5316\u4e86\u5c31\u662fMOVE\uff0c\u4e0d\u53d8\u5c31\u662fREOPEN\u3002\\n\\nASSIGN: GET_ASSIGN_CANDIDATE -> OPEN -> CONFIRM_OPENED  \\nUNASSIGN: CLOSE -> CONFIRM_CLOSED  \\nMOVE/REOPEN: CLOSE -> CONFIRM_CLOSE -> GET_ASSIGN_CANDIDATE -> OPEN -> CONFIRM_OPENED  \\n\\n\u7b80\u56fe\u4e2d\u4e00\u4e9b\u5f02\u5e38\u60c5\u51b5\u4e0b\u7684\u72b6\u6001\u6d41\u8f6c\u6ca1\u6709\u5c55\u793a\u51fa\u6765\uff0c\u6bd4\u5982\u5982\u679cclose\u5931\u8d25\uff0c\u4f1a\u518d\u5c06region open\uff0c\u7136\u540e\u518dclose\uff0c\u5c31\u4f1a\u5728\u73af\u4e0a\u8f6c\u5708\u3002\u5c31\u662f\u8bf4\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u95ee\u9898\uff0c\u5c31\u4f1a\u5728\u73af\u4e0a\u5faa\u73af\u6267\u884c\uff0c\u76f4\u5230\u6ee1\u8db3\u6761\u4ef6\u8fbe\u5230lastState\u6700\u7ec8\u51fa\u73af\u3002\\n\\n![TRSP\u72b6\u6001\u56fe](TRSP.png)\\n\\n**\u51c6\u5907\u5de5\u4f5c**\\n\\n\u6267\u884c\u4e4b\u524d\u5fc5\u987b\u83b7\u53d6RegionStateNode\u7684\u9501\uff0c\u56e0\u4e3a\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u591a\u6b21\u5bf9\u5176\u4e2d\u7684\u6570\u636e\uff08state\u3001regionLocation\uff09\u505a\u4fee\u6539\uff0c\u524d\u9762\u8bb2\u8fc7\uff0c\u4e3a\u4fdd\u8bc1RegionStateNode\u7684\u5c5e\u6027\u4e0d\u4f1a\u5e76\u53d1\u4fee\u6539\uff0c\u6240\u6709\u4fee\u6539\u4e4b\u524d\u90fd\u8981\u5148\u62ff\u9501\u3002\\n\\n**GET_ASSIGN_CANDIDATE**\\n\\n\u4e3b\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u4e3aRegion\u6307\u5b9a\u4e00\u4e2aRS\uff0c\u5c06Region\u653e\u5165AM\u7684pendingAssignQueue\u4e4b\u540e\uff0c\u76f4\u63a5suspend\u7b49\u5f85\u3002AM\u4ee5\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u6a21\u5f0f\u4e3aRegion\u6307\u5b9aRS\uff0c\u7136\u540e\u5524\u9192Procedure\u3002\\n\\n**OPEN**\\n\\n1. \u5982\u679c\u6ca1\u6709\u6307\u5b9aregionLocation\uff0c\u5219\u6709\u53ef\u80fd\u662f\u4e0a\u4e00\u6b65GET_ASSIGN_CANDIDATE\u51fa\u73b0\u95ee\u9898\u3002\u6216\u8005\u4e0a\u4e00\u6b65\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0cMaster\u91cd\u542f\uff0cProcedure\u91cd\u8bd5\u6267\u884c\u4e86\u3002\u8fd9\u65f6\u5019\u91cd\u65b0\u6267\u884c\u4e0a\u4e00\u6b65\u5c31\u597d\u4e86\u3002\\n2. \u5982\u679c\u6210\u529f\u5236\u5b9a\u4e86regionLocation\uff0c\u5c31\u901a\u8fc7OpenRegionProcedure\u53bb\u901a\u77e5RS open\u8be5region\u3002\\n   1. \u5982\u679cOpenRegionProcedure\u6700\u7ec8\u6210\u529f\u6267\u884c\u5b8c\u4e86\uff0cTRSP\u7ee7\u7eed\u6267\u884c\\n   2. \u5982\u679c\u5931\u8d25\u4e86\uff0c\u4f1a\u5728\u4e0b\u4e00\u6b65CONFIRM_OPENED\u8fdb\u884c\u91cd\u8bd5\\n   3. \u5982\u679cMaster\u91cd\u542f\uff0c\u5bfc\u81f4\u65e0\u6cd5\u5524\u9192\uff0cOpenRegionProcedure\u6709\u8d85\u65f6\u673a\u5236\uff0c\u8d85\u65f6\u4e4b\u540e\u4f1a\u518d\u91cd\u8bd5\u3002\\n\\n**CONFIRM_OPENED**\\n\\n\u68c0\u67e5OPEN\u64cd\u4f5c\u6700\u7ec8\u662f\u5426\u6210\u529f\u3002\\n\\n1. \u5982\u679cRegion\u6210\u529fOPEN\\n   1. \u8981\u770blastState\u662f\u5426\u5c31\u662fCONFIRM_OPENED\uff0c\u662f\u7684\u8bdd\u5c31\u5b8c\u4e8b\u4e86\u3002\\n   2. \u4e0d\u662f\u7684\u8bdd\u8981\u518d\u6267\u884cCLOSE\u64cd\u4f5c\u3002\u5c31\u50cf\u7b80\u56fe\u4e2d\u7684\u73af\u4e0a\u4e00\u6837\u6267\u884c\u3002\u6709\u53ef\u80fd\u51fa\u73b0\u7684\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u5f53merge/split region\u7684\u65f6\u5019\uff0c\u8981unassign\u4e00\u4e2aregion\uff0c\u4f46\u8fc7\u7a0b\u4e2dRS crash\u4e86\uff0c\u5c31\u5f97\u5148\u628a\u8fd9\u4e2aregion open\u4e86\uff0c\u518d\u6267\u884cunassign\u64cd\u4f5c\uff0c\u9632\u6b62RS crash\u65f6\u6570\u636e\u4e22\u5931\u65e0\u6cd5\u6062\u590d\u3002\\n2. \u91cd\u8bd5\u6b21\u6570\u8fbe\u5230\u4e0a\u9650\uff0c\u76f4\u63a5\u7ed3\u675f\\n3. \u62b9\u6389regionLocation\uff0c\u91cd\u65b0\u6267\u884cGET_ASSIGN_CANDIDATE\\n\\n**CLOSE**\\n\\n1. region\u5f53\u524d\u7684\u72b6\u6001\u5408\u7406\uff0c\u901a\u8fc7CloseRegionProcedure\uff0c\u6267\u884c\u8fc7\u7a0b\u7c7b\u4f3c\u4e8eOpenRegionProcedure\u3002\\n2. \u4e0d\u5408\u7406\u76f4\u63a5\u518d\u53bbGET_ASSIGN_CANDIDATE\u8d70OPEN\u7684\u903b\u8f91\\n\\n**CONFIRM_CLOSED**\\n\\n1. \u5982\u679cRegion\u5f53\u524d\u72b6\u6001\u662fCLOSE\uff0c\u8bf4\u660e\u4e0a\u4e00\u6b65\u6267\u884c\u6210\u529f\u4e86\\n   1. \u5982\u679clastState == CONFIRM_CLOSED\uff0c\u8bf4\u660e\u5f53\u524d\u72b6\u6001\u5c31\u662f\u8981\u6c42\u7684\u6700\u7ec8\u72b6\u6001\uff0c\u53ef\u4ee5\u7ed3\u675f\u4e86\u3002\\n   2. \u5426\u5219\uff0c\u8bf4\u660e\u53ef\u80fd\u662fmove\u6216\u8005reopen\u64cd\u4f5c\uff0c\u9700\u8981\u518dassign region\uff0c\u53bbGET_ASSIGN_CANDIDATE\u8d70OPEN\u7684\u903b\u8f91\u3002**\u53ea\u6709\u8fd9\u4e00\u4e2a\u5730\u65b9\u56de\u5230GET_ASSIGN_CANDIDATE\u6ca1\u6709\u62b9\u6389regionLocation**\u3002\\n2. \u5982\u679cRegion\u5f53\u524d\u72b6\u6001\u662fCLOSING\uff0c\u8bf4\u660eclose rpc\u6267\u884c\u5931\u8d25\u4e86\uff0crs\u6ca1\u6709\u56de\u8c03\u901a\u77e5\uff08eg. rs\u91cd\u542f\u4e86\uff09\uff0c\u4e00\u76f4\u7b49\u5230\u4e86CloseRegionProcedure\u8d85\u65f6\u89e6\u53d1\u4e86TRSP\u7ee7\u7eed\u6267\u884c\uff0c\u624d\u8d70\u5230\u4e86\u5f53\u524d\u72b6\u6001\uff0c\u9700\u8981\u518d\u91cd\u65b0Close\u4e00\u6b21\u3002\\n3. \u8d70\u5230\u8fd9\u91cc\u7684Region\u53ef\u80fd\u662fABNORMALLY_CLOSED\u72b6\u6001\uff0c\u5e94\u8be5\u53ea\u6709RS crash\u624d\u4f1a\u5bfc\u81f4\u8fd9\u4e2a\u72b6\u6001\u3002\\n   1. \u5982\u679c\u975edefault region\uff0cABNORMALLY_CLOSED\u53ef\u4ee5\u88ab\u5f53\u4f5cCLOSE\u5904\u7406\uff0c\u76f4\u63a5\u7ed3\u675f\u6389\u3002\u53ea\u6709\u5f00\u542f\u4e86read region replicas\u529f\u80fd\u624d\u6709\u8fd9\u6837\u7684region\u3002\u975edefault region\u4e0d\u63a5\u6536\u5199\u64cd\u4f5c\uff0c\u6240\u4ee5\u5373\u4f7f\u975e\u6b63\u5e38close\u4e5f\u4e0d\u4f1a\u9020\u6210\u6570\u636e\u4e22\u5931\u3002\\n   2. Region close\u5f02\u5e38\uff0c\u9700\u8981\u518dopen\u4e4b\u540e\u518d\u6b63\u5e38close\uff0c\u4fdd\u8bc1\u6570\u636e\u4e0d\u4f1a\u4e22\u5931\u3002\u539f\u56e0\u548cCONFIRM_OPENED\u91cc\u7684\u903b\u8f91\u7c7b\u4f3c\uff0c\u6bd4\u5982merge/split region\u7684\u65f6\u5019\uff0c\u8981\u5148close region\uff0c\u5982\u679c\u5931\u8d25\u4e86\uff0c\u5219\u5fc5\u987b\u5148\u6062\u590dregion\u518d\u91cd\u65b0close\uff0c\u907f\u514d\u6570\u636e\u4e22\u5931\u3002\\n\\n### \u95ee\u9898\\n\\n**region merge/split\u662f\u600e\u4e48\u5904\u7406\u7684\uff1f**\\n\\nregion merge/split\u5206\u522b\u662f\u7531MergeTableRegionsProcedure\u548cSplitTableRegionProcedure\u6765\u6267\u884c\u7684\uff0c\u5b83\u4eec\u6b65\u6b65\u9aa4\u90fd\u53ef\u4ee5\u62c6\u5206\u6210region assign/unassign\uff0c\u4e5f\u5c31\u4f1a\u62c6\u6210\u4e0d\u540c\u7684TRSP\u53bb\u6267\u884c\u3002\\n\\n\u4ee5 region split\u4e3a\u4f8b\\n\\n1. close\u7236region\uff08unassign\uff09\\n2. \u5904\u7406\u597d\u5b50region\u7684\u4fe1\u606f\u4fdd\u5b58\u4e4b\u540e\\n3. open\u5b50region\uff08assign\uff09\\n\\n### RegionRemoteProcedureBase\\n\\nRegionRemoteProcedureBase\u662fOpenRegionProcedure\u548cCloseRegionProcedure\u7684\u7236\u7c7b\uff0c\u5b9e\u73b0\u4e86\u57fa\u672c\u7684RPC\u76f8\u5173\u529f\u80fd\u3002RegionRemoteProcedureBase\u4e0eTRSP\u7684\u914d\u5408\u4e3b\u8981\u4e5f\u662f\u5229\u7528\u4e86ProcedureEvent\u673a\u5236\u3002\\n\\n![RegionRemoteProcedureBase\u65f6\u5e8f\u56fe](RegionRemoteProcedureBase.png)\\n\\n1. addOperationToNode\u65b9\u6cd5\u5c31\u662f\u5c06RPC\u64cd\u4f5c\u5c01\u88c5\u8d77\u6765\uff0c\u653e\u5230\u4e00\u4e2a\u96c6\u5408\u4e2d\u7b49\u5f85\u6267\u884c\u3002\\n2. \u6267\u884c\u5f53\u524dRegion\u7684ProcedureEvent.suspend\u64cd\u4f5c\uff0c\u7b49\u5f85RPC\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\u5524\u9192\u3002\\n3. RSProcedureDispatcher\u4f1a\u5206\u6279\u5c06RPC\u64cd\u4f5c\u6309RS\u548c\u64cd\u4f5c\u7c7b\u578b\u5206\u7c7b\uff0c\u6279\u91cf\u8bf7\u6c42\u67d0\u4e2aRS\u3002\\n4. RS\u6267\u884c\u5b8c\u5bf9\u5e94\u64cd\u4f5c\u4e4b\u540e\uff0c\u901a\u8fc7reportTransition\u901a\u77e5AM\uff08\u5f53\u7136\u4e2d\u95f4\u8fd8\u6709Master\uff09\uff0cRegion open/close\u5b8c\u6210\u3002\\n5. \u7136\u540eAM\u5c31\u4f1a\u5524\u9192RegionStateNode.event\uff0c\u7ee7\u7eed\u6267\u884cRegionRemoteProcedureBase\\n6. RegionRemoteProcedureBase\u6267\u884c\u5b8c\u6210\u4e4b\u540e\uff0c\u7ee7\u7eed\u6267\u884cTRSP\u540e\u7eed\u6b65\u9aa4\u3002\\n\\n#### \u95ee\u9898\\n\\n**RPC\u56de\u8c03\u4e4b\u540e\uff0c\u600e\u4e48\u786e\u5b9a\u5bf9\u5e94\u7684\u54ea\u4e2aProcedure\uff1f**\\n\\nRegionInfo -> AM.regionStates (\u7c7b\u578b RegionStates) -> RegionStates.regionMap (\u7c7b\u578b Map<byte[], RegionStateNode>) -> RegionStateNode.procedure (\u7c7b\u578b TRSP) -> TRSP.remoteProc (\u7c7b\u578b RegionRemoteProcedureBase) -> RegionRemoteProcedureBase.reportTransition\\n\\n**RS\u91cd\u542f\u5bfc\u81f4\u6ca1\u6709RPC\u56de\u8c03\uff0c\u6216\u8005Master\u91cd\u542f\u4e4b\u540eevent\u961f\u5217\u4e22\u5931 \u600e\u4e48\u529e\uff1f**\\n\\nRegionRemoteProcedureBase\u6709\u4e2a\u8d85\u65f6\u9650\u5236\uff0c\u8d85\u65f6\u4e4b\u540e\u91cd\u65b0\u518d\u6267\u884c\u4e00\u6b21\u3002"},{"id":"HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","metadata":{"permalink":"/blog/HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb/index.md","source":"@site/blog/HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb/index.md","title":"HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","description":"\u6700\u8fd1\u63a5\u5230\u4e24\u4e2a\u7528\u6237\u63d0\u7684JIRA\uff0c\u90fd\u662f\u76ee\u524d\u6570\u636e\u53ea\u5b58\u5728\u4e86\u4e00\u4e2asrv\u96c6\u7fa4\uff0c\u9700\u8981\u5c06\u6570\u636e\u5907\u4efdprc\u96c6\u7fa4\u505a\u6570\u636e\u5907\u4efd\u6216\u8005\u79bb\u7ebf\u8ba1\u7b97\uff0c\u540c\u65f6\u4e24\u96c6\u7fa4\u4e4b\u95f4\u8fd8\u8981\u505a\u6570\u636e\u5b9e\u65f6\u540c\u6b65\u3002\u6240\u4ee5\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e0b\u64cd\u4f5c\u8fc7\u7a0b\u5e76\u4ecb\u7ecd\u4e0b\u539f\u56e0\u3002","date":"2020-03-14T15:42:00.000Z","formattedDate":"2020\u5e743\u670814\u65e5","tags":[{"label":"HBase","permalink":"/blog/tags/h-base"}],"readingTime":3.015,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","title":"HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","date":"2020-03-14T15:42","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["HBase"]},"prevItem":{"title":"HBase SCP & TRSP","permalink":"/blog/HBase-SCP-and-TRSP"},"nextItem":{"title":"Maven\u9879\u76ee\u4ee5Shaded\u5f62\u5f0f\u5f15\u5165\u7b2c\u4e09\u65b9\u4f9d\u8d56\u5e93","permalink":"/blog/Shaded-Thirdparty-Dependencies"}},"content":"\u6700\u8fd1\u63a5\u5230\u4e24\u4e2a\u7528\u6237\u63d0\u7684JIRA\uff0c\u90fd\u662f\u76ee\u524d\u6570\u636e\u53ea\u5b58\u5728\u4e86\u4e00\u4e2asrv\u96c6\u7fa4\uff0c\u9700\u8981\u5c06\u6570\u636e\u5907\u4efdprc\u96c6\u7fa4\u505a\u6570\u636e\u5907\u4efd\u6216\u8005\u79bb\u7ebf\u8ba1\u7b97\uff0c\u540c\u65f6\u4e24\u96c6\u7fa4\u4e4b\u95f4\u8fd8\u8981\u505a\u6570\u636e\u5b9e\u65f6\u540c\u6b65\u3002\u6240\u4ee5\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e0b\u64cd\u4f5c\u8fc7\u7a0b\u5e76\u4ecb\u7ecd\u4e0b\u539f\u56e0\u3002\\n\\n\x3c!-- truncate --\x3e\\n\\n\\n\u96c6\u7fa4\u4e4b\u95f4\u589e\u91cf\u6570\u636e\u540c\u6b65\u81ea\u7136\u662f\u5229\u7528replication\uff0c\u5355\u5411\u540c\u6b65\u914d\u7f6e\u4e00\u4e2apeer\uff0c\u53cc\u5411\u540c\u6b65\u914d\u7f6e\u4e24\u4e2apeer\u5c31\u597d\u3002\\n\\n\u5b58\u91cf\u6570\u636e\u4f7f\u7528snapshot\u540c\u6b65\u3002\\n\\n## \u64cd\u4f5c\u6b65\u9aa4\\n\\n**0. \u51c6\u5907\u5de5\u4f5c**\\n\\n\u5728prc\u96c6\u7fa4\u65b0\u5efanamespace\\n```\\ncreate_namespace \'ns\'\\n```\\n\\n**1. \u65b0\u5efasrv\u5230prc\u96c6\u7fa4\u7684peer**\\n\\n**\u6ce8\u610fpeer\u8981disable\u6389**\\n\\n\u5982\u679c\u4e4b\u524d\u6ca1\u6709srv\u5230prc\u96c6\u7fa4\u7684peer\uff0c\u76f4\u63a5\u65b0\u5efapeer\\n```\\n// \u590d\u5236namespace\\nadd_peer \'1\', CLUSTER_KEY => \\"zk1,zk2,zk3:11000:/hbase/prc\\", STATE => \\"DISABLED\\", NAMESPACES => [\\"ns\\"]\\n// \u590d\u5236table\\nadd_peer \'1\', CLUSTER_KEY => \\"zk1,zk2,zk3:11000:/hbase/prc\\", STATE => \\"DISABLED\\", TABLE_CFS => { \\"ns:table1\\" => [] }\\n```\\n\u5982\u679c\u4e4b\u524d\u5df2\u7ecf\u6709srv\u5230prc\u96c6\u7fa4\u7684peer\uff0c\u5728peer\u4e2d\u52a0\u5165\u8981\u64cd\u4f5c\u7684namespace\\n```\\ndisable_peer \'1\'\\n// \u65b0\u52a0namespace\\nappend_peer_namespaces \'1\', [\\"ns\\"]\\n// \u65b0\u52a0table\\nappend_peer_tableCFs \'1\', { \\"ns:table1\\" => []}\\n```\\n\\n**2. \u6253snapshot**\\n\\n\u5c06\u8981\u540c\u6b65\u7684\u8868\u6253snapshot\uff0c\u5982\u679c\u590d\u5236\u6574\u4e2anamespace\uff0c\u8981\u4e00\u4e2a\u4e00\u4e2a\u6253\\n\\n```\\nsnapshot \'ns:table1\', \'ns_table1_snapshot\'\\n```\\n\\n**3. \u5c06snapshot\u590d\u5236\u5230prc\u96c6\u7fa4**\\n\\n\u4f7f\u7528`ExportSnapshot`\u5c06snapshot\u4ecesrv\u590d\u5236\u5230prc\u96c6\u7fa4\\n\\n```\\n./bin/hbase --config /path/to/conf org.apache.hadoop.hbase.snapshot.ExportSnapshot -copy-from hdfs://srv/hbase/srv -copy-to hdfs://prc/hbase/prc -snapshot ns_table1_snapshot -mappers 100 -bandwidth 512 -overwrite >> copy.log 2>&1 &\\n```\\n\\n**4. \u5728prc\u96c6\u7fa4\u4f7f\u7528snapshot\u751f\u6210\u8868**\\n\\n```\\nclone_snapshot \'ns_table1_snapshot\', \'ns:table1\'\\n```\\n\\n**5. \u5f00\u542fpeer**\\n\\n\u5c06srv\u5230prc\u96c6\u7fa4\u7684peer\u6253\u5f00\\n\\n```\\nenable_peer \'1\'\\n```\\n\\n**6. \u5176\u4ed6**\\n\\n\u5728peer\u96c6\u7fa4\u52a0\u6743\u9650\\n```\\ngrant \'kerberos_name\', \'RW\', \'@ns1\'\\n```\\n\\n\u5982\u679c\u9700\u8981\u4fe9\u96c6\u7fa4\u53cc\u5411\u540c\u6b65\uff0c\u5728\u589e\u52a0prc\u5230srv\u96c6\u7fa4\u7684peer\\n```\\nadd_peer \'2\', CLUSTER_KEY => \\"zk1,zk2,zk3:11000:/hbase/srv\\", STATE => \\"ENABLED\\", NAMESPACES => [\\"ns\\"]\\n```\\n\\n## \u64cd\u4f5c\u539f\u56e0\\n\\n\u6570\u636e\u590d\u5236\u81ea\u7136\u4e0d\u80fd\u4e22\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u8981\u4fdd\u8bc1snapshot\u7684\u5b58\u91cf\u6570\u636e\u548creplication\u7684\u589e\u91cf\u6570\u636e\u4e4b\u95f4\u4e0d\u80fd\u6709\u95f4\u9699\uff0c\u4f46\u5176\u5b9e\u53ef\u4ee5\u6709\u91cd\u53e0\u3002\\n\\n\u6211\u4eec\u5148\u65b0\u5efareplication peer\uff0c\u5c06\u73b0\u6709\u7684WAL\u548c\u4e4b\u540e\u518d\u751f\u6210\u7684WAL\u90fd\u52a0\u8fdb\u8be5peer\u7684\u590d\u5236\u961f\u5217\u4e2d\uff0cdisable\u6389peer\u7684\u539f\u56e0\u5219\u662fprc\u96c6\u7fa4\u8fd8\u6ca1\u6709\u65b0\u5efa\u8868\uff0creplication\u5f00\u59cb\u590d\u5236\u5219\u4f1a\u51fa\u73b0`Table xxx does not exist`\u7684\u62a5\u9519\u3002\u8fd9\u4e00\u6b65\u5982\u679c\u662f\u4fee\u6539\u7684\u539f\u6709peer\uff0c\u5219\u4f1a\u5bfc\u81f4replication\u5ef6\u8fdf\u589e\u52a0\u3002\\n\\n\u4e4b\u540e\u518d\u6253snapshot\u4fbf\u4e0d\u7528\u62c5\u5fc3\u6570\u636e\u6709\u4e22\u5931\u4e86\uff0c\u6b64\u65f6replication\u7684\u6570\u636e\u4e0esnapshot\u7684\u6570\u636e\u5df2\u7ecf\u6709\u91cd\u53e0\u4e86\u3002\\n\\n\u6700\u540e\u603b\u7ed3\u4e00\u53e5\uff0c\u4e00\u5b9a\u8981\u5148\u65b0\u5efareplication peer\uff0c\u7136\u540e\u5728\u6253snapshot\u3002"},{"id":"Shaded-Thirdparty-Dependencies","metadata":{"permalink":"/blog/Shaded-Thirdparty-Dependencies","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/Shaded-Thirdparty-Dependencies/index.md","source":"@site/blog/Shaded-Thirdparty-Dependencies/index.md","title":"Maven\u9879\u76ee\u4ee5Shaded\u5f62\u5f0f\u5f15\u5165\u7b2c\u4e09\u65b9\u4f9d\u8d56\u5e93","description":"\u6700\u8fd1\u6709\u7528\u6237\u53cd\u9988\uff0c\u4ed6\u7684\u9879\u76ee\u4e2d\u540c\u65f6\u4f7f\u7528\u4e86HBase\u548c\u4e00\u4e2aRPC\u6846\u67b6\uff0cHBase\u4f9d\u8d562.5.0\u7684protobuf\uff0cRPC\u6846\u67b6\u4f9d\u8d563.7\u7684protobuf\uff0c\u5bfc\u81f4\u4ed6\u7684\u9879\u76ee\u7f16\u8bd1\u90fd\u5931\u8d25\u30020.98\u7248\u672c\u7684HBase\u8fd8\u662f\u4f7f\u7528\u7684\u539f\u751f\u7684protobuf-java\u4f9d\u8d56\uff0c2.0\u7248\u672c\u624d\u4f7f\u7528\u4e86shaded\u5f62\u5f0f\u7684protobuf\uff0c\u6240\u4ee5\u6211\u4eec\u51b3\u5b9a\u81ea\u5df1\u63d0\u4f9b\u4ee5shaded\u5f62\u5f0f\u5f15\u5165protobuf\u7684HBase Client\u3002","date":"2020-01-13T17:46:00.000Z","formattedDate":"2020\u5e741\u670813\u65e5","tags":[{"label":"Java","permalink":"/blog/tags/java"}],"readingTime":4.075,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"Shaded-Thirdparty-Dependencies","title":"Maven\u9879\u76ee\u4ee5Shaded\u5f62\u5f0f\u5f15\u5165\u7b2c\u4e09\u65b9\u4f9d\u8d56\u5e93","date":"2020-01-13T17:46","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Java"]},"prevItem":{"title":"HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb","permalink":"/blog/HBase\u4e0d\u505c\u670d\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb"},"nextItem":{"title":"\u521d\u6b65\u4e86\u89e3HBase Region Replicas","permalink":"/blog/Initial-Analysis-Region-Replicas"}},"content":"\u6700\u8fd1\u6709\u7528\u6237\u53cd\u9988\uff0c\u4ed6\u7684\u9879\u76ee\u4e2d\u540c\u65f6\u4f7f\u7528\u4e86HBase\u548c\u4e00\u4e2aRPC\u6846\u67b6\uff0cHBase\u4f9d\u8d562.5.0\u7684protobuf\uff0cRPC\u6846\u67b6\u4f9d\u8d563.7\u7684protobuf\uff0c\u5bfc\u81f4\u4ed6\u7684\u9879\u76ee\u7f16\u8bd1\u90fd\u5931\u8d25\u30020.98\u7248\u672c\u7684HBase\u8fd8\u662f\u4f7f\u7528\u7684\u539f\u751f\u7684protobuf-java\u4f9d\u8d56\uff0c2.0\u7248\u672c\u624d\u4f7f\u7528\u4e86shaded\u5f62\u5f0f\u7684protobuf\uff0c\u6240\u4ee5\u6211\u4eec\u51b3\u5b9a\u81ea\u5df1\u63d0\u4f9b\u4ee5shaded\u5f62\u5f0f\u5f15\u5165protobuf\u7684HBase Client\u3002\\n\\n\u76f8\u4fe1\u8fd9\u4e2a\u95ee\u9898\u4e0d\u53ea\u662f\u51fa\u73b0\u5728HBase\u4e2d\uff0c\u6216\u8005\u51fa\u73b0\u5728\u4e0eprotobuf\u76f8\u5173\u7684\u9879\u76ee\u4e2d\uff0c\u5176\u5b9e\u5f53\u6211\u4eec\u9879\u76ee\u95f4\u63a5\u4f9d\u8d56\u4e86\u50cfprotobuf\u3001netty\u7b49\u5927\u7248\u672c\u4e4b\u95f4\u4e92\u4e0d\u517c\u5bb9\u7684\u6846\u67b6\uff0c\u751a\u81f3guava\u8fd9\u79cd\u67d0\u4e9b\u63a5\u53e3\u4e0d\u517c\u5bb9\u7684\u6846\u67b6\uff0c\u90fd\u6709\u53ef\u80fd\u51fa\u73b0\u7c7b\u4f3c\u7684\u95ee\u9898\u3002\u8fd9\u91cc\u4e5f\u662f\u63d0\u4f9b\u4e00\u4e2a\u53ef\u4ee5\u53c2\u8003\u7684\u89e3\u51b3\u65b9\u6cd5\u3002\\n\\n\u65b9\u6cd5\u4e0a\uff0c\u53c2\u8003\u4e86HBase 2.0\u4e4b\u540e\u5bf9\u7b2c\u4e09\u65b9\u4f9d\u8d56\u7684\u5904\u7406\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u5e38\u7528\u7b2c\u4e09\u65b9\u4f9d\u8d56\u7684\u4ee3\u7801\u8d1f\u8d23\u4e00\u4efd\uff0c\u4fee\u6539\u6240\u6709\u7c7b\u7684package\uff0c\u53d1\u5e03\u4e00\u4e2a\u81ea\u5df1\u7684artifact\u5230\u4ed3\u5e93\u4e2d\u3002\u8fd9\u6837\u80af\u5b9a\u5c31\u4e0d\u4f1a\u518d\u4f9d\u8d56\u51b2\u7a81\u4e86\u3002\\n\\n\u800cprotobuf\u7684\u4f9d\u8d56\u5904\u7406\u8d77\u6765\u5219\u6bd4\u8f83\u9ebb\u70e6\u4e00\u70b9\uff0c\u9664\u4e86\u4fee\u6539\u539f\u751fprotobuf\u7c7b\u7684package\u4e4b\u5916\uff0c\u8fd8\u9700\u8981\u5904\u7406proto\u751f\u6210\u7684Java\u6587\u4ef6\u3002\u6240\u4ee5\u672c\u6587\u5c31\u4ee5protobuf\u4e3a\u4f8b\uff0c\u63d0\u4f9b\u7b2c\u4e09\u65b9\u4f9d\u8d56\u51b2\u7a81\u7684\u89e3\u51b3\u65b9\u6848\u3002\u56e0\u4e3a\u90fd\u662f\u4f7f\u7528Maven\u63d2\u4ef6\u5b9e\u73b0\uff0c\u6240\u4ee5\u4e5f\u53ea\u5bf9Maven\u9879\u76ee\u6709\u7528\uff0c\u76f8\u4fe1\u5176\u4ed6\u9879\u76ee\u4e5f\u6709\u7c7b\u4f3c\u7684\u89e3\u51b3\u529e\u6cd5\u3002\\n\\n\u672c\u6587\u76f8\u5173\u4ee3\u7801\u90fd\u5df2\u653e\u5728[Github](https://github.com/ddupg/demos/tree/master/shaded)\\n\\n\x3c!-- truncate --\x3e\\n\\n## \u751f\u6210shaded\u4f9d\u8d56\u5305\\n\\n\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003[pom.xml\u7684\u4ee3\u7801](https://github.com/ddupg/demos/blob/master/shaded/pom.xml)\uff0c\u5176\u4e2d\u4e3b\u8981\u4f7f\u7528\u5230\u7684\u63d2\u4ef6\u662f\u4ee5\u4e0b\u51e0\u4e2a\uff1a\\n- maven-dependency-plugin \u5c06protobuf\u4f9d\u8d56\u5305\u4e0b\u8f7d\u4e0b\u6765\u5e76\u89e3\u5305\u653e\u5728src/main/java\u76ee\u5f55\u4e0b\uff0c\u53d8\u6210\u81ea\u5df1\u9879\u76ee\u7684\u6e90\u7801\\n- maven-shade-plugin \u5728\u6253\u5305\u9636\u6bb5\uff0c\u4fee\u6539protobuf\u7c7b\u7684package\u540d\u3002\u4f8b\u5982HBase\u9879\u76ee\u662f\u5c06`com.google.protobuf`\u6539\u4e3a`org.apache.hbase.thirdparty.com.google.protobuf`\uff0c\u6211\u7684\u4ee3\u7801\u4e2d\u662f\u5c06`com.google.protobuf`\u6539\u4e3a`ddupg.demo.thirdparty.com.google.protobuf`\\n- maven-clean-plugin \u5728\u64cd\u4f5c\u4e4b\u524d\uff0c\u6e05\u7406\u4e0b\u4e4b\u524d\u751f\u6210\u7684\u6587\u4ef6\\n\\n\u4fee\u6539\u597dpom\u6587\u4ef6\u4e4b\u540e\uff0c\u76f4\u63a5mvn clean deploy\u53d1\u5e03\u5230\u4ed3\u5e93\u5c31\u597d\u4e86\uff0c\u4e2d\u592e\u4ed3\u5e93\u548c\u79c1\u6709\u4ed3\u5e93\u90fd\u662f\u4e00\u6837\u7684\u3002\\n\\n\u53ef\u4ee5\u89e3\u538btarget\u76ee\u5f55\u4e0b\u6253\u597d\u7684\u5305\uff0c\u5c31\u53ef\u4ee5\u770b\u5230class\u6587\u4ef6\u7684package\u8def\u5f84\u5df2\u7ecf\u53d8\u5316\u4e86\u3002\u56e0\u4e3a\u662f\u5728package\u9636\u6bb5\u624d\u4fee\u6539\u7684package\u540d\uff0c\u6240\u4ee5\u76f4\u63a5\u770btarget/generated-sources\u4e0b\u7684class\u6587\u4ef6\u5176\u5b9e\u662f\u4e0d\u53d8\u7684\u3002\\n\\n\u666e\u901a\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56\u9879\u76ee\u4f7f\u7528\u8fd9\u4e00\u6b65\u5176\u5b9e\u5c31\u53ef\u4ee5\u89e3\u51b3\u4e86\u3002\\n\\n## \u751f\u6210proto\u6587\u4ef6\\n\\n\u89e3\u51b3\u6389\u4e86protobuf\u7684\u6e90\u6587\u4ef6\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u5904\u7406proto\u751f\u6210\u7684\u6587\u4ef6\u4e86\u3002\\n\\n\u56e0\u4e3a\u9700\u8981\u4f9d\u8d56\u4e0a\u4e00\u6b65\u751f\u6210\u7684shaded\u5305\uff0c\u800c\u6211\u53c8\u6ca1\u6709\u5c06\u5b83deploy\u5230\u4e2d\u592e\u4ed3\u5e93\uff0c\u4e5f\u6ca1\u6709\u81ea\u5df1\u7684\u79c1\u4eba\u4ed3\u5e93\uff0c\u6240\u4ee5\u4fbf\u4f7f\u7528\u4e86[HBase\u9879\u76ee\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56](https://github.com/apache/hbase-thirdparty)\uff0c\u9053\u7406\u90fd\u4e00\u6837\uff0c\u66ff\u6362\u4e00\u4e0bdependency\u5c31\u597d\u4e86\u3002\\n\\n\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003[pom.xml\u7684\u4ee3\u7801](https://github.com/ddupg/demos/blob/master/shaded/shaded-protocol/pom.xml).\\n\\n\u8fd9\u4e00\u6b65\u4e3b\u8981\u4f7f\u7528\u7684\u63d2\u4ef6\uff1a\\n- protobuf-maven-plugin \u751f\u6210proto\u6587\u4ef6\uff0c\u8fd9\u4e00\u6b65\u751f\u6210\u7684\u6587\u4ef6\u4f9d\u65e7\u4f7f\u7528\u7684\u662f\u539f\u751fprotobuf\u3002\\n- com.google.code.maven-replacer-plugin:replacer \u66ff\u6362\u6e90\u4ee3\u7801\uff0c\u5c06protobuf\u539f\u751f\u7684package\u8def\u5f84`com.google.protobuf`\u6539\u6210\u7b2c\u4e00\u6b65\u4e2d\u4fee\u6539\u540e\u7684package\u540d\u3002\u56e0\u4e3a\u6211\u5728\u8fd9\u91cc\u4f7f\u7528\u7684HBase\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56\u9879\u76ee\uff0c\u6240\u4ee5\u5c31\u662f\u5c06`com.google.protobuf`\u6539\u4e3a`org.apache.hbase.thirdparty.com.google.protobuf`\\n\\n## \u53c2\u8003\\n\\n- [Maven Protocol Buffers Plugin](https://www.xolstice.org/protobuf-maven-plugin/)\\n- [Apache Maven Shade Plugin](https://maven.apache.org/plugins/maven-shade-plugin/)\\n- [maven-replacer-plugin](https://code.google.com/archive/p/maven-replacer-plugin/)"},{"id":"Initial-Analysis-Region-Replicas","metadata":{"permalink":"/blog/Initial-Analysis-Region-Replicas","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/Initial-Analysis-Region-Replicas/index.md","source":"@site/blog/Initial-Analysis-Region-Replicas/index.md","title":"\u521d\u6b65\u4e86\u89e3HBase Region Replicas","description":"\u80cc\u666f","date":"2019-12-05T15:00:00.000Z","formattedDate":"2019\u5e7412\u67085\u65e5","tags":[{"label":"HBase","permalink":"/blog/tags/h-base"}],"readingTime":23.3,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"Initial-Analysis-Region-Replicas","title":"\u521d\u6b65\u4e86\u89e3HBase Region Replicas","date":"2019-12-05T15:00","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["HBase"]},"prevItem":{"title":"Maven\u9879\u76ee\u4ee5Shaded\u5f62\u5f0f\u5f15\u5165\u7b2c\u4e09\u65b9\u4f9d\u8d56\u5e93","permalink":"/blog/Shaded-Thirdparty-Dependencies"},"nextItem":{"title":"\u300c\u8bb0\u300dJdk8 CompletableFuture\u5728\u9ad8\u5e76\u53d1\u73af\u5883\u4e0b\u7684\u6027\u80fd\u95ee\u9898","permalink":"/blog/CompletableFuture-in-high-concurrent"}},"content":"\x3c!-- truncate --\x3e\\n\\n## \u80cc\u666f\\n\\nCAP\u539f\u7406\u4e2d\uff0c\u6307\u51fa\u5bf9\u4e8e\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u6765\u8bf4\uff0c\u4e0d\u53ef\u80fd\u540c\u65f6\u6ee1\u8db3\u4e00\u81f4\u6027 (Consistency)\u3001\u53ef\u7528\u6027\uff08Availability\uff09\u3001\u5206\u533a\u5bb9\u9519\u6027\uff08Partition tolerance\uff09\uff0c\u800cHBase\u5219\u88ab\u8bbe\u8ba1\u6210\u4e00\u4e2aCP\u7cfb\u7edf\uff0c\u4fdd\u8bc1\u4e86\u5f3a\u4e00\u81f4\u6027\u7684\u540c\u65f6\uff0c\u9009\u62e9\u727a\u7272\u4e86\u4e00\u5b9a\u7684\u53ef\u7528\u6027\u3002\\n\\n\u5728\u5bf9HBase\u7684\u538b\u6d4b\u4e2d\uff0c\u5f88\u5bb9\u6613\u53d1\u73b0\u867d\u7136HBase\u7684\u5e73\u5747\u8bfb\u5199\u5ef6\u8fdf\u5f88\u4f4e\uff0c\u4f46\u5374\u5b58\u5728\u5f88\u9ad8\u7684\u6bdb\u523a\uff0cP99\u3001P999\u5ef6\u8fdf\u5f88\u9ad8\uff0c\u4e3b\u8981\u7684\u4e00\u4e2a\u5f71\u54cd\u56e0\u7d20\u5219\u662f\u5355\u70b9\u7684GC\uff0c\u53e6\u5916Region\u7684MTTR\uff08\u5e73\u5747\u4fee\u590d\u65f6\u95f4\uff09\u4e5f\u8f83\u9ad8\uff0c\u4e00\u65e6\u67d0\u4e2aRegionServer\u5b95\u673a\u6216\u67d0\u4e2aRegion\u51fa\u73b0\u95ee\u9898\uff0c\u751a\u81f3\u662f\u4e00\u6b21Full GC\uff0c\u90fd\u6709\u53ef\u80fd\u51fa\u73b0\u8f83\u957f\u65f6\u95f4\u7684\u4e0d\u53ef\u7528\uff0c\u5f71\u54cd\u53ef\u7528\u6027\u3002\\n\\nHBase\u7684Read Region Replicas\u529f\u80fd\uff0c\u63d0\u4f9b\u4e00\u4e2a\u6216\u591a\u4e2a\u526f\u672c\uff0c\u5728region\u6062\u590d\u671f\u95f4\u6216\u8bf7\u6c42\u65f6\u95f4\u8fc7\u957f\u65f6\uff0c\u652f\u6301\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u8bfb\u670d\u52a1\u3002\u5728\u4e00\u4e9b\u4e0d\u8981\u6c42\u5f3a\u4e00\u81f4\u6027\u7684\u5e94\u7528\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u6b64\u529f\u80fd\u6765\u63d0\u9ad8\u53ef\u7528\u6027\u964d\u4f4e\u8bfb\u8bf7\u6c42\u5ef6\u8fdf\u3002\\n\\n\u4e3a\u4e86\u5b9e\u73b0\u9ad8\u53ef\u7528\u8bfb\uff0cHBase\u63d0\u4f9b\u4e86\u4e00\u4e2afeature\uff0c\u53eb`region replication`\u3002\u5728\u8fd9\u79cd\u6a21\u578b\u4e0b\uff0c\u8868\u7684\u6bcf\u4e2aregion\uff0c\u90fd\u4f1a\u6709\u591a\u4e2a\u526f\u672c\uff0c\u5206\u5e03\u5728\u4e0d\u540c\u7684RegionServer\u4e0a\u3002\u9ed8\u8ba4region replication\u4e3a1\uff0c\u6b64\u65f6\u4e0e\u4e4b\u524d\u7684region\u6a21\u578b\u5e76\u65e0\u4e0d\u540c\u3002\u5f53region replication\u88ab\u8bbe\u7f6e\u4e3a2\u6216\u66f4\u591a\u65f6\uff0cMaster\u5c06\u4f1aassign\u6240\u6709region\u7684secondary region\uff0cLoad Balancer\u4f1a\u4fdd\u8bc1\u540c\u4e00\u4e2aregion\u7684\u591a\u4e2a\u5907\u4efd\u4f1a\u88ab\u5206\u6563\u5728\u4e0d\u540c\u7684RegionServer\u4e0a\u3002\\n\\n\u4e00\u4e2aregion\u7684\u6240\u6709\u526f\u672c\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684replica_id\u3002replica_id=0\u7684\u662fprimary region\uff08\u548c\u4e4b\u524d\u6a21\u578b\u4e2d\u552f\u4e00\u7684region\u4e00\u6837\uff09\uff0c\u5176\u4ed6\u7684\u526f\u672cregion\u88ab\u90fd\u53eb\u505asecondary region\u3002\\n\\nprimary region\uff0c\u652f\u6301\u8bfb\u5199\u8bf7\u6c42\uff1bsecondary region\uff0c\u53ea\u652f\u6301\u8bfb\u8bf7\u6c42\u3002\u5982\u6b64\u8bbe\u8ba1\u4fdd\u8bc1primary region\u4f9d\u65e7\u5177\u6709\u5f3a\u4e00\u81f4\u6027\uff0c\u540c\u65f6\u63d0\u9ad8\u8bfb\u53ef\u7528\u6027\u3002\u4f46\u4e5f\u56e0\u4e3a\u5199\u8bf7\u6c42\u53ea\u6709primary region\u53ef\u4ee5\u5904\u7406\uff0c\u6240\u4ee5\u5199\u8bf7\u6c42\u4f9d\u7136\u4f1a\u56e0\u4e3aprimary region\u4e0d\u53ef\u7528\u800c\u88ab\u963b\u585e\uff0cHBase\u7684\u5199\u53ef\u7528\u6027\u4f9d\u7136\u6ca1\u6709\u5f97\u5230\u6539\u5584\u3002\\n\\n## Timeline Consistency\\n\\n\u5728\u8be5\u529f\u80fd\u7684\u5b9e\u73b0\u4e2d\uff0cHBase\u63d0\u4f9b\u4e86\u4e00\u79cd\u652f\u6301**\u5355\u6b21\u8bfb\u8bf7\u6c42**\u7684\u4e00\u81f4\u6027\u5b9a\u4e49\u3002\\n\\n```Java\\npublic enum Consistency {\\n    STRONG,\\n    TIMELINE\\n}\\n```\\n\\nHBase\u9ed8\u8ba4\u7684\u5c31\u662f`Consistency.STRONG`\u5f3a\u4e00\u81f4\u6027\u6a21\u578b\uff0c\u4e0e\u4e4b\u524d\u7684\u6a21\u578b\u4e00\u6837\uff0c\u6240\u6709\u8bfb\u5199\u64cd\u4f5c\u90fd\u901aprimary region\u5b8c\u6210\u3002\\n\\n\u800c\u5f53client\u4f7f\u7528`Consistency.TIMELINE`\u7684\u4e00\u81f4\u6027\u53d1\u8d77\u8bfb\u8bf7\u6c42\u65f6\uff0c\u4f1a\u9996\u5148\u5411primary region\u53d1\u8d77\u8bf7\u6c42\uff0c\u4e00\u5b9a\u65f6\u95f4\u5185\u6ca1\u6709\u8fd4\u56de\u54cd\u5e94\uff0c\u5219\u540c\u65f6\u5e76\u53d1\u5411\u6240\u6709\u7684secondary region\u53d1\u8d77\u8bf7\u6c42\uff0c\u6700\u7ec8\u91c7\u7528\u7387\u5148\u8fd4\u56de\u7684\u8bf7\u6c42\u3002\u4e3a\u4e86\u533a\u5206\u6700\u7ec8\u7684\u54cd\u5e94\u662f\u5426\u6765\u81easecondary region\uff0c\u5728`Result`\u4e2d\u589e\u52a0\u4e86`stale`\u7684boolean\u5c5e\u6027\uff0c`true`\u5219\u8868\u793a\u6765\u81easecondary region\u3002\\n\\n\u4ece\u8bed\u4e49\u4e0a\u8bb2\uff0cHBase\u7684TIMELINE\u4e00\u81f4\u6027\u5e76\u4e0d\u540c\u4e8e\u5e38\u89c1\u7684\u6700\u7ec8\u4e00\u81f4\u6027\u89e3\u51b3\u65b9\u6848\u3002\\n\\n- \u5373\u4f7f\u5b58\u5728\u591a\u526f\u672c\uff0c\u4e5f\u4e0d\u9700\u8981\u8003\u8651\u526f\u672c\u4e4b\u95f4\u6570\u636e\u51b2\u7a81\u7684\u95ee\u9898\u3002\\n- secondary region\u63a5\u6536primary region\u540c\u6b65\u7684\u6570\u636e\uff0c\u6309\u540c\u6837\u987a\u5e8f\u5904\u7406\u6570\u636e\uff0c\u6240\u4ee5secondary region\u603b\u662fprimary region\u5728\u4e4b\u524d\u67d0\u4e2a\u65f6\u523b\u7684\u5feb\u7167\u3002\u4ece\u8fd9\u4e00\u70b9\u4e0a\u770b\uff0c\u66f4\u50cf\u662fRDBMS\uff08\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff09\u7684\u590d\u5236\u3001\u6216\u662fHBase\u591a\u6570\u636e\u4e2d\u5fc3\u591a\u96c6\u7fa4\u4e4b\u95f4\u7684\u590d\u5236\u3002\\n- \u53e6\u4e00\u65b9\u9762\uff0cclient\u53ef\u4ee5\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u9700\u8981\u8bfb\u53d6\u6700\u65b0\u6570\u636e\uff0c\u81ea\u884c\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u4e00\u81f4\u6027\u6765\u6ee1\u8db3\u529f\u80fd\u9700\u6c42\u3002\\n- client\u4f9d\u7136\u4f1a\u8bfb\u5230\u4e71\u5e8f\u7684\u6570\u636e\uff0c\u6bd4\u5982\u591a\u6b21\u8bf7\u6c42\u53d1\u5f80\u4e86\u4e0d\u540c\u7684region\u3002\u76ee\u524d\u5e76\u6ca1\u6709\u7c7b\u4f3c\u4e8e\u4e8b\u52a1\u7684\u4e1c\u897f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\\n\\n![Timeline Consistency](timeline_consistency.png)\\n\\n\u6839\u636e\u4e0a\u56fe\u6211\u4eec\u6765\u66f4\u597d\u7684\u7406\u89e3TIMELINE\u7684\u8bed\u4e49\u3002\u9996\u5148client1\u6309\u987a\u5e8f\u5199\u4e86x=1,x=2,x=3\uff0cprimary region\u4e5f\u6309\u5199\u5165\u987a\u5e8f\u5904\u7406\uff0c\u5e76\u5c06WAL\u540c\u6b65\u7ed9\u5176\u4ed6secondary region\uff08\u4e00\u79cd\u6570\u636e\u540c\u6b65\u65b9\u5f0f\uff0c\u540e\u9762\u4f1a\u518d\u8bb2\uff09\u3002\u5728\u56fe\u4e2d\u6ce8\u610f\u5230\uff0creplica_1\u53ea\u63a5\u6536\u5230\u4e24\u6b21\u66f4\u65b0\uff0c\u6240\u4ee5\u6700\u7ec8\u6570\u636e\u662fx=2\uff0creplica_2\u53ea\u63a5\u6536\u52301\u6b21\u66f4\u65b0\uff0c\u6570\u636e\u662fx=1\u3002\\n\\n\u5982\u679cclient1\u4f7f\u7528STRONG\u4e00\u81f4\u6027\u6765\u8bfb\u6570\u636e\uff0c\u90fd\u53ea\u4f1a\u548cprimary region\u4ea4\u4e92\uff0c\u6570\u636e\u90fd\u662f\u6700\u65b0\u503cx=3\u3002\u53ef\u5982\u679c\u4f7f\u7528TIMELINE\u4e00\u81f4\u6027\u8bfb\u53d6\u6570\u636e\uff0c\u6709\u53ef\u80fd\u548c\u6240\u6709\u526f\u672c\u505a\u4ea4\u4e92\uff0c\u6700\u7ec8\u83b7\u5f97\u7684\u6570\u636e1\u30012\u30013\u90fd\u6709\u53ef\u80fd\u3002\u5982\u679cclient\u8bf7\u6c42\u591a\u6b21\uff0c\u751a\u81f3\u53ef\u80fd\u51fa\u73b0\u6570\u636e\u56de\u9000\uff0c\u5373\u7b2c1\u6b21\u8bf7\u6c42\u83b7\u5f97x=2\uff0c\u7b2c2\u6b21\u8bf7\u6c42\u5219\u83b7\u5f97\u4e86x=1\u3002\\n\\n## \u5b9e\u73b0\\n\\n### \u6570\u636e\u6a21\u578b\\n\\n![\u4e00\u4e2aregion replication\u4e3a2\u7684\u8868\u5728meta\u8868\u4e2d\u7684\u5217](meta.png \\"\u4e00\u4e2aregion replication\u4e3a2\u7684\u8868\u5728meta\u8868\u4e2d\u7684\u5217\\")\\n\\n\u5728\u4e0a\u56fe\u4e2d\uff0c\u662f\u4e00\u4e2aregion replication\u4e3a2\u7684\u8868\u5728meta\u8868\u4e2dinfo\u5217\u65cf\u4e0b\u7684\u5217\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e9b\u540d\u4e3ainfo:xxx_0001\u7684\u5217\uff0c\u8fd9\u4e9b\u5217\u5b58\u50a8\u7684\u6570\u636e\u5c31\u662freplica_id=1\u7684secondary region\u7684\u6570\u636e\u3002\u540c\u7406\uff0c\u5f53region\u7684\u5907\u4efd\u6570\u91cf\u66f4\u591a\u65f6\uff0cmeta\u8868\u4e2d\u540d\u4e3ainfo:xxx_0002\u3001info:xxx_0003\u7684\u5217\u5b58\u50a8\u7684\u5219\u4e3areplica_id\u4e3a2\u30013\u7684secondary region\u7684\u6570\u636e\u3002\\n\\n\u660e\u767d\u4e86meta\u8868\u4e2d\u662f\u5982\u4f55\u5b58\u50a8secondary region\u6570\u636e\uff0cclient\u8981\u83b7\u53d6secondary region\u6240\u5728\u7684RegionServer\u81ea\u7136\u4e5f\u7b80\u5355\uff0c\u591a\u89e3\u6790\u51e0\u4e2aserver_xxxx\u7684\u5217\u4fbf\u53ef\u4ee5\u4e86\u3002\\n\\n![client\u8bbf\u95eesecondary region](client-read-replicas.png \\"client\u8bbf\u95eesecondary region\\")\\n\\n\u4e0a\u56fe\u5c55\u793a\u7684\u662fclient\u8bbf\u95eesecondary region\u7684\u793a\u610f\u56fe\u3002HBase\u7684\u8bfb\u8bf7\u6c42\u6709\u4e24\u79cd\uff0cGet\u548cScan\u3002\u5bf9\u4e8eGet\u8fd9\u79cd\u65e0\u72b6\u6001\u7684\u8bf7\u6c42\uff0c\u6bcf\u6b21RPC\u5bf9server\u7aef\u6765\u8bf4\u90fd\u662f\u4e00\u6b21\u72ec\u7acb\u7684\u8bf7\u6c42\u3002client\u7aef\u7684\u7528\u6237\u53ef\u4ee5\u591a\u6b21\u8d85\u65f6\u91cd\u8bd5\uff0c\u76f4\u5230\u83b7\u53d6\u5230\u6570\u636e\uff1b\u4e5f\u53ef\u4ee5\u5e76\u53d1\u8bf7\u6c42\u591a\u4e2areplica\uff0c\u9009\u62e9\u7387\u5148\u8fd4\u56de\u7684\u6570\u636e\uff1b\u8fd8\u53ef\u4ee5\u4f7f\u7528TIMELINE Read\uff0c\u8bf7\u6c42primary region\u8d85\u65f6\u4e4b\u540e\u518d\u8bf7\u6c42\u5176\u4ed6secondary region\u3002\u4f46\u5bf9\u4e8eScan\u8fd9\u79cd\u6709\u72b6\u6001\u7684\u8bf7\u6c42\uff0c\u4e00\u6b21scan\u53ef\u80fd\u4e0e\u540c\u4e00\u4e2aregion\u4ea4\u4e92\u591a\u6b21\uff0c\u4e5f\u53ef\u80fd\u8de8\u591a\u4e2aregion\u591a\u4e2aRegionServer\u8bf7\u6c42\u6570\u636e\uff0cserver\u7aef\u4f1a\u8bb0\u5f55\u6bcf\u4e2ascan\u7684\u72b6\u6001\u6570\u636e\uff0c\u90a3\u4e48\u4e00\u6b21scan\u4ea7\u751f\u7684\u591a\u6b21RPC\u4fbf\u4e0d\u80fd\u968f\u610f\u5730\u53d1\u7ed9\u6240\u6709\u7684replica\u3002\\n\\n![client scan\u8fc7\u7a0b](client_scan_replicas.png \\"client scan\u8fc7\u7a0b\\")\\n\\n\u4e0a\u56fe\u5c55\u793a\u7684\u662fclient\u6267\u884c\u4e00\u4e2a\u8de8region\u7684scan\u8fc7\u7a0b\uff0c\u5047\u8bbe\u5f53\u524d\u8868\u67092\u4e2a\u903b\u8f91region\uff08Region_A\u548cRegion_B\uff09\uff0cregion\u7684\u8d77\u59cb\u533a\u95f4\u5206\u522b\u4e3a[a, d)\u3001[d, f)\uff0c\u4e14\u8be5\u8868\u7684region replication\u4e3a2\uff0c\u5373\u6bcf\u4e2a\u903b\u8f91region\u90fd\u6709\u4e00\u4e3b\u4e00\u5907\uff0c4\u4e2aregion\u5206\u5e03\u57284\u4e2aRegionServer\u4e0a\u3002\u5f53\u6211\u4eec\u6267\u884c\u4e00\u6b21scan\u64cd\u4f5c\uff0c\u8bbe\u7f6ecacheing\u4e3a2\uff08\u6bcf\u6b21RPC\u6700\u591a\u83b7\u53d62\u4e2aResult\uff09\uff0c\u5219scan\u81f3\u5c11\u8fdb\u884c4\u6b21RPC\uff0c\u56fe\u4e2d\u8fde\u7ebf\u5219\u8868\u793a\u6bcf\u6b21RPC\uff0c\u8fde\u7ebf\u4e0a\u7684\u6570\u5b57\u8868\u793aRPC\u7684\u987a\u5e8f\u7f16\u53f7\uff0c\u865a\u7ebf\u8868\u793aRPC\u8d85\u65f6\u6216\u8fd4\u56de\u592a\u6162\u7ed3\u679c\u6ca1\u6709\u88ab\u91c7\u7528\u3002\u53ef\u4ee5\u770b\u5230\u5f53client\u8981\u8fdb\u884c\u7b2c1\u6b21RPC\u65f6\uff0c\u5c06\u8bf7\u6c42\u540c\u65f6\u53d1\u7ed9\u4e86Region_A\u7684\u4e3b\u59072\u4e2aregion\uff0c\u56e0\u4e3a\u6b64\u65f6server\u7aef\u662f\u6ca1\u6709\u4efb\u4f55\u5173\u4e8e\u6b64\u6b21scan\u7684\u72b6\u6001\u6570\u636e\uff0cclient\u53ef\u4ee5\u9009\u62e9\u7387\u5148\u8fd4\u56de\u54cd\u5e94\u7684region\u8fdb\u884c\u540e\u7eed\u7684RPC\u4ea4\u4e92\u3002\u5f53\u7b2c2\u6b21RPC\u65f6\u4fbf\u4e0d\u53ef\u4ee5\u968f\u610f\u9009\u62e9region\u4e86\uff0c\u56e0\u4e3aRegion_A_primary\u5b58\u50a8\u4e86\u6b64\u6b21scan\u7684\u72b6\u6001\u6570\u636e\uff0c\u800cRegion_A_replica_1\u6ca1\u6709\uff0c\u5982\u679c\u8bf7\u6c42Region_A_replica_1\u5219\u53ea\u4f1a\u629b\u51fa\u5f02\u5e38\u3002\u5f53\u7b2c2\u6b21RPC\u7ed3\u675f\uff0c\u5df2\u7ecf\u83b7\u53d6\u4e86Region_A\u4e2d\u7684\u5168\u90e8\u6570\u636e\uff0c\u4fbf\u53ef\u4ee5\u6e05\u7406\u6389Region_A_primary\u4e2d\u5b58\u50a8\u7684\u72b6\u6001\u6570\u636e\u4e86\u3002\u5f53\u7b2c3\u6b21RPC\u65f6\uff0c\u548c\u7b2c1\u6b21\u65f6\u60c5\u51b5\u6709\u4e9b\u7c7b\u4f3c\uff0cserver\u7aef\u6682\u65f6\u6ca1\u6709\u5b58\u50a8scan\u7684\u72b6\u6001\u6570\u636e\u4e86\uff0cclient\u4fbf\u53ef\u4ee5\u50cf\u7b2c1\u6b21RPC\u4e00\u6837\uff0c\u5c06\u8bf7\u6c42\u540c\u65f6\u53d1\u7ed9\u4e86Region_A\u7684\u4e3b\u59072\u4e2aregion\u3002\u7b2c4\u6b21RPC\u5219\u50cf\u7b2c2\u6b21\u4e00\u6837\u3002\u603b\u7ed3\u4e00\u4e0b\uff1a\u5f53scan\u8fdb\u884cTIMELINE Read\u65f6\uff0c\u53ea\u6709\u5bf9\u6bcf\u4e2a\u903b\u8f91region\u7684\u7b2c1\u6b21rpc\u53ef\u4ee5\u4efb\u610f\u9009\u62e9region\u8bf7\u6c42\u3002\\n\\n\u76ee\u524d\uff0cRead Region Replicas\u529f\u80fd\u5e76\u6ca1\u6709\u652f\u6301\u6279\u91cf\u8bf7\u6c42\uff0c\u5373\u6279\u91cfGet\u3001Scan\u90fd\u662f\u76f4\u63a5\u8bf7\u6c42primary region\u3002\\n\\n### \u6570\u636e\u540c\u6b65\\n\\nsecondary region\u8981\u652f\u6301\u8bfb\u8bf7\u6c42\uff0c\u5219\u5fc5\u7136\u8981\u6709\u6570\u636e\uff0c\u800csecondary region\u53c8\u4e0d\u652f\u6301\u5199\u8bf7\u6c42\uff0c\u90a3\u4e48\u6570\u636e\u662f\u54ea\u6765\u7684\u5462\uff1f\\n\\n![RegionServer \u5185\u90e8\u7ed3\u6784](rs-structure.png \\"RegionServer \u5185\u90e8\u7ed3\u6784\\")\\n\\n\u4eceHBase\u7684\u6570\u636e\u6a21\u578b\u4e0a\u770b\uff0c\u6570\u636e\u4e3b\u8981\u5206\u4e3a\u4e24\u90e8\u5206\uff1aMemStore\u548cHFile\u3002HFile\u5b58\u50a8\u4e8eHDFS\u4e0a\uff0csecondary region\u53ea\u8981\u53ca\u65f6\u83b7\u77e5HFile\u7684\u53d8\u5316\u4fbf\u53ef\u4ee5\u83b7\u53d6\u3002\u4f46MemStore\u5b58\u5728\u4e8e\u5185\u5b58\uff0c\u5374\u53ea\u6709primary region\u6301\u6709\u3002\u4ee5\u4e0b\u4fbf\u4ecb\u7ecd\u4e24\u79cdsecondary region\u540c\u6b65\u6570\u636e\u7684\u65b9\u5f0f\u3002\\n\\n#### StoreFile Refresher\\n\\n\u7b2c\u4e00\u79cd\u65b9\u5f0f\u662fStoreFile Refresher\uff0c\u5728HBase-1.0+\u7248\u672c\u5f15\u5165\u3002\u5728RegionServer\u4e0a\u6709\u4e00\u4e2aStorefileRefresherChore\u4efb\u52a1\uff0c\u4f1a\u5b9a\u671f\u5730\u5728HDFS\u4e0a\u68c0\u67e5primary region\u7684HFile\u6709\u6ca1\u6709\u53d8\u5316\uff0c\u4ee5\u6b64\u6765\u53ca\u65f6\u7684\u53d1\u73b0primary region\u901a\u8fc7flush\u3001compact\u3001bulk load\u7b49\u64cd\u4f5c\u4ea7\u751f\u7684\u65b0HFile\u3002\\n\\n\u8be5\u65b9\u6848\u5b9e\u73b0\u4e0a\u8f83\u4e3a\u7b80\u5355\uff0c\u4e5f\u4e0d\u9700\u8981\u592a\u591a\u591a\u4f59\u7684\u5b58\u50a8\u548c\u7f51\u7edc\u5f00\u9500\uff0c\u4f46\u7f3a\u70b9\u4e5f\u975e\u5e38\u660e\u663e\uff0c\u5728\u6570\u636e\u5199\u5165primary region\uff0c\u5230secondary region\u53ef\u4ee5\u8bfb\u5230\u6570\u636e\uff0c\u6709\u76f8\u5f53\u957f\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u4e2d\u95f4\u9700\u8981\u7b49\u5f85memstore\u7684flush\u548cStorefileRefresherChore\u4efb\u52a1\u7684\u5b9a\u65f6\u5237\u65b0\u3002\\n\\n\u5982\u679c\u8981\u5f00\u542f\u8fd9\u4e2a\u529f\u80fd\uff0c\u53ea\u8981\u5c06`hbase.regionserver.storefile.refresh.period`\u914d\u7f6e\u8bbe\u7f6e\u4e3a\u975e\u96f6\u503c\u5373\u53ef\uff0c\u8868\u793aStorefileRefresherChore\u4efb\u52a1\u5237\u65b0\u7684\u65f6\u95f4\u95f4\u9694\u3002\\n\\n#### Asynchronous Replication\\n\\nHBase\u6709\u63d0\u4f9b\u96c6\u7fa4\u95f4replication\u529f\u80fd\uff0c\u5229\u7528WAL\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u540c\u6b65\u6570\u636e\u3002\u5728HBase-1.1+\u7248\u672c\u4e2d\uff0c\u4fbf\u5229\u7528replication\u5728\u96c6\u7fa4\u5185\u90e8\u540c\u6b65\u6570\u636e\uff0c\u5c06\u5b9e\u65f6\u5199\u5165\u7684WAL\u540c\u6b65\u5230secondary region\u3002\\n\\n![Asynchronous Replication\u793a\u610f\u56fe](region_replica_replication.png \\"Asynchronous Replication \u793a\u610f\u56fe\\")\\n\\n\u5982\u4e0a\u56fe\u4e2d\u6240\u793a\uff0c\u901a\u8fc7\u5b9e\u73b0\u4e00\u4e2a\u7279\u6b8a\u7684`ReplicationEndpoint`\u4fbf\u53ef\u4ee5\u5c06WAL\u7684\u6570\u636e\u540c\u6b65\u7ed9\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6RegionServer\u3002\u5982\u6b64primary region MemStore\u4e2d\u7684\u6570\u636e\uff0c\u4e5f\u901a\u8fc7replication\u5b9e\u65f6\u540c\u6b65\u5230secondary region\uff0c\u4ecesecondary region\u4e2d\u4e5f\u53ef\u4ee5\u8bfb\u5230primary region\u8fd8\u6ca1\u6709flush\u5230HFile\u7684\u6570\u636e\u3002\u6240\u4ee5\u5229\u7528`Asnyc WAL replication`\u7684\u540c\u6b65\u65b9\u5f0f\u6bd4\u4e0a\u9762\u8bb2\u5230\u7684`StoreFile Refresher`\u540c\u6b65\u65b9\u5f0f\u5177\u6709\u66f4\u4f4e\u7684\u540c\u6b65\u5ef6\u8fdf\u3002\\n\\nprimary region\u8fd8\u4f1a\u5c06flush\u3001compaction\u548cbulk load\u4e8b\u4ef6\u5199\u5230WAL\uff0c\u540c\u6837\u7531replication\u529f\u80fd\u540c\u6b65\u5230secondary region\u3002\u5f53secondary region\u63a5\u6536\u5230\u8fd9\u4e9b\u4e8b\u4ef6\u65f6\uff0c\u4fbf\u4e5f\u56de\u653e\u540c\u6837\u7684\u4e8b\u4ef6\u6765\u66f4\u65b0\u81ea\u5df1\u7684\u6570\u636e\u3002\u6240\u4ee5\u5bf9HFile\u6587\u4ef6\u5217\u8868\u7684\u66f4\u65b0\u4e5f\u6bd4`StoreFile Refresher`\u5b9a\u65f6\u5237\u65b0\u7684\u65b9\u5f0f\u66f4\u52a0\u5b9e\u65f6\u3002\\n\\n\u5728\u8fd9\u79cd\u540c\u6b65\u6a21\u5f0f\u4e0b\uff0csecondary region\u7684MemStore\u4e2d\u4e5f\u662f\u6709\u6570\u636e\uff0c\u4eceWAL\u540c\u6b65\u7684Put/Delete\u64cd\u4f5c\u5c31pPrimaryrRegion\u4e00\u6837\u5199\u5165MemStore\uff0c\u5e76\u4e14secondary region\u4e5f\u4f1a\u4f7f\u7528block cache\uff0c\u6240\u4ee5\u5728\u8fd9\u79cd\u6a21\u5f0f\u4e2d\u5185\u5b58\u7684\u5f00\u9500\u4f1a\u6210\u500d\u7684\u589e\u957f\u3002\u4e0d\u540c\u4e8eprimary region\u7684\u662f\uff0csecondary region\u5728\u63a5\u6536\u5230flush\u4e8b\u4ef6\u65f6\uff0c\u5e76\u4e0d\u4f1a\u5c06MemStore\u4e2d\u7684\u6570\u636eflush\u6210HFile\uff0c\u53ea\u4f1a\u91ca\u653e\u6389MemStore\u5360\u7528\u7684\u5185\u5b58\u3002\\n\\n`Asnyc WAL replication`\u529f\u80fd\u9ed8\u8ba4\u662f\u5173\u95ed\u7684\u3002\u9700\u8981\u8bbe\u7f6e`hbase.region.replica.replication.enabled`\u4e3a`true`\u6765\u6253\u5f00\u8fd9\u4e2a\u529f\u80fd\u3002\u5f53\u7b2c\u4e00\u6b21\u521b\u5efa\u4e00\u4e2aregion replication\u5927\u4e8e1\u7684\u8868\u65f6\uff0c\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a`region_replica_replication`\u7684replication peer\uff0c\u8fd9\u4e2areplication peer\u5c06\u8d1f\u8d23\u96c6\u7fa4\u5185\u6240\u6709\u8868region replica\u7684\u6570\u636e\u540c\u6b65\u3002\u4e00\u65e6\u5f00\u542f\u4e4b\u540e\u60f3\u8981\u518d\u5173\u95ed\u8be5\u529f\u80fd\uff0c\u5c31\u4e0d\u53ea\u662f\u6539`hbase.region.replica.replication.enabled`\u4e3a`false`\u4e86\uff0c\u8fd8\u9700\u8981disable\u6389`region_replica_replication`\u8fd9\u4e2areplication peer\u3002\\n\\n### \u5b58\u5728\u7684\u95ee\u9898\\n\\n#### HFile\u7684\u8fc7\u671f\u65f6\u95f4\\n\\n\u5728\u4ee5\u4e0a\u4e24\u79cd\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e2d\uff0c\u90fd\u4f1a\u5728\u591a\u4e2aRegionServer\u4e0a\u6253\u5f00\u540c\u4e00\u4e2aHFile\uff0c\u6240\u4ee5\u5f53primary region\u8fdb\u884c\u5b8c\u4e86major compaction\u4e4b\u540e\uff0csecondary region\u56e0\u4e3aHFile\u6587\u4ef6\u53d8\u5316\u66f4\u65b0\u4e0d\u53ca\u65f6\uff0c\u4f9d\u65e7\u5f15\u7528\u7740\u65e7\u7684HFile\u3002\u76ee\u524d\u5e76\u6ca1\u6709\u6709\u6548\u7684\u63aa\u65bd\u4fdd\u8bc1HFile\u6587\u4ef6\u5e76\u4e0d\u4f1a\u88ab\u8fc7\u65e9\u7684\u5220\u9664\u3002\u53ea\u80fd\u662f\u5c06\u914d\u7f6e\u9879`hbase.master.hfilecleaner.ttl`\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u8f83\u5927\u7684\u503c\uff0c\u6bd4\u5982\u4e00\u5c0f\u65f6\uff0c\u4ee5\u6b64\u6765\u5c3d\u91cf\u907f\u514d\u8bf7\u6c42\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u51fa\u9519\u3002\u4f46\u540c\u65f6\u4e5f\u4f1a\u589e\u52a0HDFS\u7684\u5b58\u50a8\u5f00\u9500\u3002\\n\\n#### replication\u4e0d\u80fd\u540c\u6b65meta\u8868\u6570\u636e\\n\\n\u76ee\u524d\u7684Asynchronous Replication\u529f\u80fd\u5e76\u4e0d\u80fd\u540c\u6b65meta\u8868\u7684WAL\u6570\u636e\uff08\u6700\u521d\u8be5\u529f\u80fd\u662f\u7528\u4e8e\u96c6\u7fa4\u95f4\u540c\u6b65\u6570\u636e\u7684\uff0c\u6bd5\u7adf\u4e0d\u80fd\u628ameta\u6570\u636e\u540c\u6b65\u7ed9\u5176\u4ed6\u96c6\u7fa4\uff09\u3002\u6240\u4ee5\u5bf9\u4e8emeta\u8868\u7684\u64cd\u4f5c\uff0c\u5e76\u4e0d\u80fd\u901a\u8fc7replication\u5c3d\u5feb\u7684\u540c\u6b65\u5230secondary region\uff0c\u53ea\u80fd\u901a\u8fc7\u7c7b\u4f3c\u4e8e`StoreFile Refresher`\u7684\u65b9\u5f0f\uff0c\u4f7f\u7528\u5b9a\u65f6\u5237\u65b0\u7684\u4efb\u52a1\u6765\u540c\u6b65meta\u8868HFile\u6587\u4ef6\u7684\u53d8\u5316\u3002\\n\\n`hbase.regionserver.meta.storefile.refresh.period`\u914d\u7f6e\u9879\u7528\u4e8e\u63a7\u5236meta\u8868StoreFile\u7684\u66f4\u65b0\u65f6\u95f4\u3002\u8be5\u914d\u7f6e\u9879\u5e76\u4e0d\u540c\u4e8e`StoreFile Refresher`\u529f\u80fd\u7684`hbase.regionserver.storefile.refresh.period`\u3002\\n\\n#### \u5185\u5b58\u6d88\u8017\\n\\n\u5728\u4e4b\u524d\u5df2\u7ecf\u63d0\u5230\uff0cAsynchronous Replication\u540c\u6b65\u56e0\u4e3a\u4f7f\u7528MemStore\u548cblock cache\uff0c\u4f1a\u5bfc\u81f4\u5185\u5b58\u5f00\u9500\u6210\u500d\u589e\u52a0\u3002\u5e76\u4e14secondary region\u5e76\u4e0d\u4f1a\u4e3b\u52a8\u8fdb\u884cflush\uff0c\u53ea\u4f1a\u5f53\u63a5\u6536\u5230\u540c\u6b65\u7684WAL\u4e2d\u7684flush\u4e8b\u4ef6\u65f6\uff0c\u624d\u4f1a\u8fdb\u884cflush\u3002\u5728\u4e00\u4e9b\u6781\u7aef\u60c5\u51b5\u4e0b\uff0c\u6bd4\u5982replication\u963b\u585e\u6536\u4e0d\u5230flush\u4e8b\u4ef6\u3001primary region\u786e\u5b9e\u957f\u65f6\u95f4\u6ca1\u6709\u8fdb\u884cflushsecondaryarRegion\u6301\u6709\u7684\u5185\u5b58\u5f97\u4e0d\u5230\u91ca\u653e\uff0c\u800c\u4e00\u4e2aRegionServer\u4e0a\u540c\u65f6\u6709\u591a\u4e2aprimary region\u548csecondary region\uff0c\u5185\u5b58\u7684\u8fc7\u5ea6\u6d88\u8017\u53ef\u80fd\u4f1a\u963b\u585eprimary region\u6b63\u5e38\u7684\u5199\u5165\u64cd\u4f5c\uff0c\u4e5f\u4f1a\u963b\u585ereplication\u540c\u6b65\u7684flush\u4e8b\u4ef6\u3002\\n\\n\u6240\u4ee5HBase\u63d0\u4f9b\u4e86\u4e00\u4e2a\u914d\u7f6e\u9879`hbase.region.replica.storefile.refresh.memstore.multiplier`\uff0c\u9ed8\u8ba4\u503c\u4e3a4\uff0c\u8868\u793a\u5982\u679csecondary region\u7684MemStore\u6bd4primary region\u6700\u5927\u7684MemStore\u76844\u500d\u8fd8\u8981\u5927\u65f6\uff0c\u4fbf\u5141secondaryarRegion\u81ea\u884crefresh\u68c0\u67e5HFile\u6587\u4ef6\u662f\u5426\u53d8\u5316\uff0c\u5982\u679cprimary region\u65e9\u5df2flush\u8fc7\uff0c\u5374\u56e0\u4e3areplication\u963b\u585e\u6ca1\u6709\u540c\u6b65\u5230\uff0c\u5219\u53ef\u4ee5\u5229\u7528\u8be5\u673a\u5236\u8fdb\u884cflush\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6700\u597d\u4e0d\u8981\u6267\u884c\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u53ef\u4ee5\u628a\u8be5\u914d\u7f6e\u9879\u8bbe\u7f6e\u5927\u4e00\u4e9b\u6765\u907f\u514d\u3002\\n\\n#### secondary region Failover\\n\\n\u5f53\u4e00\u4e2asecondary region\u521aopen\u6216\u8005fail over\uff0c\u6b64\u65f6\u5fc5\u7136\u4e22\u5931\u4e86\u4e4b\u524dMemStore\u7684\u6570\u636e\uff0c\u56e0\u4e3asecondary region\u6bd5\u7adf\u4e0d\u80fd\u50cfprimary region\u4e00\u6837\u901a\u8fc7\u56de\u653eWAL\u6765\u6062\u590dMemStore\u3002\u5982\u679c\u6b64\u65f6\u76f4\u63a5\u63d0\u4f9b\u8bfb\u670d\u52a1\uff0c\u5219\u53ef\u80fd\u51fa\u73b0\u6570\u636e\u7248\u672c\u56de\u9000\u7684\u95ee\u9898\uff0c\u5373\u6062\u590d\u4e4b\u540e\u6bd4\u6062\u590d\u4e4b\u524d\u8bfb\u5230\u7684\u6570\u636e\u66f4\u65e7\u3002\u4e3a\u4e86\u907f\u514d\u6570\u636e\u56de\u9000\uff0csecondary region\u5c31\u5fc5\u987b\u7b49\u5f85primary region\u8fdb\u884c\u4e00\u6b21\u5b8c\u6574\u7684flush\u64cd\u4f5c\u6216open region\u4e8b\u4ef6\uff0c\u5728\u8fd9\u4e4b\u524d\uff0csecondary region\u90fd\u5c06\u62d2\u7edd\u63a5\u670d\u52a1\u3002\\n\\n`hbase.region.replica.wait.for.primary.flush`\u914d\u7f6e\u9879\u662f\u8be5\u673a\u5236\u7684\u5f00\u5173\uff0c\u9ed8\u8ba4\u662f`enable`\u5f00\u542f\u3002\\n\\n## \u4f7f\u7528\\n\\n### \u914d\u7f6e\\n\\n**server\u7aef**\\n\\n| \u914d\u7f6e\u9879                                                        | \u9ed8\u8ba4\u503c                                                            | \u5355\u4f4d  | \u63cf\u8ff0                                                                                           |\\n| ---------------------------------------------------------- | -------------------------------------------------------------- | --- | -------------------------------------------------------------------------------------------- |\\n| hbase.regionserver.storefile.refresh.period                | 0                                                              | \u6beb\u79d2  | secondary region\u5237\u65b0storefile\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u9ed8\u8ba40\u4e3a\u5173\u95ed                                                      |\\n| hbase.regionserver.meta.storefile.refresh.period           | 0                                                              | \u6beb\u79d2  | secondary region\u5237\u65b0hbase:meta\u8868storefile\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u9ed8\u8ba40\u4e3a\u5173\u95ed                                           |\\n| hbase.region.replica.replication.enabled                   | false                                                          |     | \u662f\u5426\u5f00\u542f`Asnyc WAL replication`\u529f\u80fd\uff0c\u5f00\u542f\u540e\u518d\u60f3\u5173\u95ed\uff0c\u9700\u8981\u6539\u4e3afalse\u4e4b\u540e\u518ddisable\u6389`region_replica_replication`\u7684peer  |\\n| hbase.master.hfilecleaner.ttl                              | 300000(5\u5206\u949f)                                                    | \u6beb\u79d2  | storefile\u6587\u4ef6\u7684\u8fc7\u671f\u5220\u9664\u65f6\u95f4\u95f4\u9694                                                                         |\\n| hbase.meta.replica.count                                   | 1                                                              | \u4e2a   | meta\u8868\u7684region replication\u6570\u91cf                                                                   |\\n| hbase.region.replica.storefile.refresh.memstore.multiplier | 4                                                              | \u500d   | secondary region\u7684MemStore\u5927\u4e8e\u540cRegionServer\u4e0aprimary region\u6700\u5927\u7684MemStore\u8be5\u500d\u6570\u65f6\uff0c\u4f1a\u89e6\u53d1\u5237\u65b0storefile\u6587\u4ef6\u5217\u8868\u7684\u4efb\u52a1 |\\n| hbase.region.replica.wait.for.primary.flush                | true                                                           |     | secondary region open\u4e4b\u540e\uff0c\u662f\u5426\u8981\u7b49\u5f85primary region\u8fdb\u884c\u4e00\u6b21flush\u518d\u63d0\u4f9b\u670d\u52a1                                    |\\n| hbase.master.loadbalancer.class                            | org.apache.hadoop.hbase.master.balancer.StochasticLoadBalancer |     | \u9ed8\u8ba4\u7684\u5b9e\u73b0\u53ef\u4ee5\u4fdd\u8bc1region\u7684replicas\u5c3d\u91cf\u4e0d\u4f1a\u5206\u5e03\u5728\u540c\u4e00\u4e2aRegionServer\u4e0a\uff0c\u5982\u679c\u4fee\u6539\u8be5\u914d\u7f6e\uff0c\u8981\u6ce8\u610freplicas\u7684\u5206\u5e03                       |\\n\\n**client\u7aef**\\n\\n| \u914d\u7f6e\u9879                                       | \u9ed8\u8ba4\u503c   | \u5355\u4f4d  | \u63cf\u8ff0                                                             |\\n| ----------------------------------------- | ----- | --- | -------------------------------------------------------------- |\\n| hbase.ipc.client.specificThreadForWriting | false |     | \u662f\u5426\u4f7f\u7528\u7279\u6b8a\u7ebf\u7a0b\u7528\u4e8e\u5199\u8bf7\u6c42\u3002\u4f7f\u7528region replicas\u529f\u80fd\uff0c\u7ecf\u5e38\u4f1a\u5728IO\u8fc7\u7a0b\u4e2d\u4e2d\u65ad\u7ebf\u7a0b\uff0c\u6240\u4ee5\u5fc5\u987b\u5f00\u542f\u8be5\u914d\u7f6e      |\\n| hbase.client.primaryCallTimeout.get       | 10000 | \u5fae\u79d2  | TIMELINE\u4e00\u81f4\u6027Get\u65f6\uff0c\u7b49\u5f85primary region\u54cd\u5e94\u7684\u65f6\u95f4\uff0c\u8d85\u65f6\u4e4b\u540e\u4fbf\u8bf7\u6c42secondary region  |\\n| hbase.client.primaryCallTimeout.scan      | 10000 | \u5fae\u79d2  | TIMELINE\u4e00\u81f4\u6027Scan\u65f6\uff0c\u7b49\u5f85primary region\u54cd\u5e94\u7684\u65f6\u95f4\uff0c\u8d85\u65f6\u4e4b\u540e\u4fbf\u8bf7\u6c42secondary region |\\n| hbase.meta.replicas.use                   | false |     | \u662f\u5426\u4f7f\u7528meta\u8868\u7684secondary region                                     |\\n\\n### \u5efa\u8868\\n\\n`REGION_REPLICATION`\u53c2\u6570\u63a7\u5236\u8868\u4e2dregion\u6709\u591a\u5c11\u5907\u4efd\uff0c\u9ed8\u8ba4\u503c\u4e3a1\uff0c\u5373\u53ea\u6709primary region\u3002\\n\\nshell\u65b9\u5f0f\u5efa\u8868\\n\\n```shell\\ncreate \'t1\', \'f1\', {REGION_REPLICATION => 2}\\n```\\n\\nshell\u65b9\u5f0f\u4fee\u6539\u8868\\n\\n```shell\\nalter \'t1\', {REGION_REPLICATION => 2}\\n```\\n\\n### Client\\n\\nClient\u8bbf\u95eesecondary region\u5fc5\u987b\u8981\u7528\u6237\u660e\u786e\u7684\u8868\u793a\u53ef\u4ee5\u63a5\u6536\u975e\u5f3a\u4e00\u81f4\u6027\u7684\u6570\u636e\uff0c\u5982\u679c\u5e0c\u671b\u8bf7\u6c42\u53ef\u4ee5\u53d1\u9001\u7ed9secondary region\uff0c\u5fc5\u987b\u660e\u786e\u6307\u5b9a\u4e3a`TIMELINE`\u7684\u4e00\u81f4\u6027\u3002\\n\\n```Java\\npublic enum Consistency {\\n    STRONG,\\n    TIMELINE\\n}\\n```\\n\\n#### Shell\\n\\n\u5141\u8bb8\u4ee5`TIMELINE`\u7684\u4e00\u81f4\u6027\u8bfb\u53d6\u6570\u636e\\n\\n```shell\\nhbase(main):001:0> get \'t1\',\'r6\', {CONSISTENCY => \\"TIMELINE\\"}\\n```\\n\\n```shell\\nhbase(main):001:0> get \'t1\',\'r6\', {CONSISTENCY => \\"TIMELINE\\", , REGION_REPLICA_ID => 1}\\n```\\n\\n#### Java\\n\\nGet\\n\\n```Java\\nGet get = new Get(row);\\nget.setConsistency(Consistency.TIMELINE);\\n...\\nResult result = table.get(get);\\n```\\n\\nScan\\n\\n```Java\\nScan scan = new Scan();\\nscan.setConsistency(Consistency.TIMELINE);\\n...\\nResultScanner scanner = table.getScanner(scan);\\n```\\n\\n\u53ef\u4ee5\u901a\u8fc7`Result.isStale()`\u5224\u65ad\u6570\u636e\u662f\u5426\u6765\u81ea\u4e8esecondary region\\n\\n```Java\\nResult result = table.get(get);\\nif (result.isStale()) {\\n  ...\\n}\\n```\\n\\n## \u6027\u80fd\u6d4b\u8bd5\\n\\n**\u673a\u5668\u914d\u7f6e**\\n\\nHBase\u7248\u672c\uff1a2.2.0\\nHDFS\u7248\u672c\uff1a 3.1.4\\n\\n| service | job           | \u5b9e\u4f8b\u6570 | cpu     | disk        | netowork | comment                |\\n| ------- | ------------- | --- | ------- | ----------- | -------- | ---------------------- |\\n| HBase   | master        | 2   | -       | -           | -        | -                      |\\n| HBase   | region server | 5   | 24 core | 12*3.7T HDD | 10000bps | onheap=50g/offheap=50g |\\n| HDFS    | namenode      | 2   | -       | -           | -        | onheap=10g             |\\n| HDFS    | datanode      | 5   | 24 core | 12*3.7T HDD | 10000bps | onheap=2g              |\\n\\n**\u4e0d\u9650\u5236QPS**\\n\\n|                  | strong    | timeline-10ms | reta    |\\n| ---------------- | --------- | ------------- | ------- |\\n| qps_sec          | 12608.23  | 11171.18      | -11.4%  |\\n| max_latency_us   | 195174.38 | 202603.69     | 3.81%   |\\n| min_latency_us   | 149.38    | 148.75        | -0.42%  |\\n| avg_latency_us   | 3760.69   | 4276.76       | 13.72%  |\\n| p90_latency_us   | 11811.92  | 14258.31      | 20.71%  |\\n| p99_latency_us   | 32512.23  | 31148.14      | -4.2%   |\\n| p999_latency_us  | 64646.38  | 58621.93      | -9.32%  |\\n| p9999_latency_us | 136835.92 | 115951.63     | -15.26% |\\n\\n**\u9650\u52367000QPS**\\n\\n|                  | strong    | timeline-10ms | reta    |\\n| ---------------- | --------- | ------------- | ------- |\\n| qps_sec          | 6999.58   | 6999.56       | -0.0%   |\\n| max_latency_us   | 126860.75 | 130148.86     | 2.59%   |\\n| min_latency_us   | 147.25    | 150.68        | 2.33%   |\\n| avg_latency_us   | 3223.38   | 3495.51       | 8.44%   |\\n| p90_latency_us   | 10612.49  | 11379.48      | 7.23%   |\\n| p99_latency_us   | 23793.54  | 24469.25      | 2.84%   |\\n| p999_latency_us  | 48791.00  | 39795.06      | -18.44% |\\n| p9999_latency_us | 93389.08  | 78618.61      | -15.82% |\\n\\n\u5bf9\u5355Client\u5b9e\u4f8b\u505a\u538b\u529b\u6d4b\u8bd5\uff0c`hbase.client.primaryCallTimeout.get`\u53c2\u6570\u8bbe\u7f6e\u4e3a10000\uff0c\u5373\u7b49\u5f85primary region\u54cd\u5e94\u7684\u65f6\u95f4\u8d85\u65f610ms\u4e4b\u540e\u4fbf\u8bf7\u6c42secondary region\u3002\\n\\n\u7b2c\u4e00\u7ec4\u6781\u9650QPS\u7684\u538b\u6d4b\u4e2d\uff0c\u53ef\u4ee5\u770b\u51fa\u5f00\u542fTIMELINE Read\u4e4b\u540e\uff0cQPS\u6709\u4e00\u5b9a\u635f\u5931\uff0c\u5e73\u5747\u5ef6\u8fdf\u6709\u4e00\u5b9a\u5347\u9ad8\uff0cP999\u548cP9999\u4e00\u5b9a\u7a0b\u5ea6\u4f18\u5316\u3002\u4f18\u5316\u6548\u679c\u6709\u9650\u3002\\n\\n\u56e0\u4e3aread replicas\u4f1a\u589e\u52a0\u7ebf\u7a0b\u8d44\u6e90\u7684\u4f7f\u7528\uff0c\u800c\u65e5\u5e38\u4f7f\u7528\u4e5f\u4e0d\u4f1a\u628aClient\u4fa7\u538b\u5230\u6781\u9650\uff0c\u6240\u4ee5\u53c8\u505a\u4e86\u4e00\u7ec4\u9650\u5236QPS\u7684\u538b\u6d4b\uff0c\u53ef\u4ee5\u770b\u5230\u5404\u9879\u5ef6\u8fdf\u6307\u6807\u5747\u6709\u6240\u597d\u8f6c\u3002\\n\\n## \u603b\u7ed3\\n\\n`Region Replica`\u529f\u80fd\u53ef\u4ee5\u63d0\u9ad8HBase\u7684\u8bfb\u53ef\u7528\u6027\uff0c\u4f46\u4e5f\u8981\u6839\u636e\u5177\u4f53\u7684\u7528\u4f8b\u8003\u8651\u662f\u5426\u9002\u7528\u3002\\n\\n### \u4f18\u70b9\\n\\n- \u5f53\u5e94\u7528\u4f9d\u8d56\u662f\u53ea\u8bfb\u7684\u8868\uff0c\u6216\u8005\u5e94\u7528\u5e76\u4e0d\u8981\u6c42\u5f3a\u4e00\u81f4\u6027\uff08\u8981\u6c42\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u53ef\u4ee5\u63a5\u53d7\u77ed\u65f6\u95f4\u5185\u6570\u636e\u4e0d\u4e00\u81f4\uff09\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u8be5\u529f\u80fd\u6765\u63d0\u9ad8\u8bfb\u53ef\u7528\u6027\u3002\u5728RegionServer\u6216Region\u51fa\u73b0\u5355\u70b9\u6545\u969c\u6062\u590d\u671f\u95f4\u6216\u957f\u65f6\u95f4Full GC\u671f\u95f4\u5c3d\u91cf\u4fdd\u8bc1\u4e1a\u52a1\u8bfb\u8bf7\u6c42\u6b63\u5e38\uff0c\u51cf\u5c11MTTR\u8fc7\u957f\u5bf9\u4e1a\u52a1\u4ea7\u751f\u7684\u5f71\u54cd\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u51cf\u5c11\u5927\u91cf\u91cd\u8bd5\u8bf7\u6c42\u8fdb\u4e00\u6b65\u5730\u589e\u52a0\u6545\u969c\u8282\u70b9\u7684\u538b\u529b\u3002\\n- \u5bf9\u4e8e\u90e8\u5206\u4e0d\u8981\u6c42\u5f3a\u4e00\u81f4\u6027\u4e14\u5bf9\u5ef6\u8fdf\u6bdb\u523a\u6709\u4e00\u5b9a\u8981\u6c42\u7684\u5e94\u7528\uff0c\u5f53\u5728Client\u4fa7QPS\u8f83\u4f4e\u6216CPU\u3001\u5e26\u5bbd\u7b49\u8d44\u6e90\u5bcc\u4f59\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u8be5\u529f\u80fd\u964d\u4f4e\u8bfb\u8bf7\u6c42P99/P999\u548cP9999\u5ef6\u8fdf\u3002\\n\\n### \u7f3a\u70b9\\n\\n- \u591a\u500d\u7684MemStore\u5bfc\u81f4\u66f4\u591a\u7684\u5185\u5b58\u6d88\u8017\\n- \u589e\u52a0block cache\u7684\u9700\u6c42\u548c\u4f7f\u7528\\n- \u4e3a\u4e86\u4f20\u8f93WAL\u5bfc\u81f4\u66f4\u591a\u7684\u7f51\u7edc\u5e26\u5bbd\u6d88\u8017\\n- \u5927\u91cf\u7684\u96c6\u7fa4\u5185\u90e8RPC\u8bf7\u6c42\\n\\n## \u53c2\u8003\\n\\n- [Timeline-consistent High Available Reads](http://hbase.apache.org/book.html#arch.timelineconsistent.reads)\\n- [HBASE-10070](https://issues.apache.org/jira/browse/HBASE-10070)\\n- [HighAvailabilityDesignforreadsApachedoc.pdf](https://issues.apache.org/jira/secure/attachment/12616659/HighAvailabilityDesignforreadsApachedoc.pdf)"},{"id":"CompletableFuture-in-high-concurrent","metadata":{"permalink":"/blog/CompletableFuture-in-high-concurrent","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/CompletableFuture-in-high-concurrent/index.md","source":"@site/blog/CompletableFuture-in-high-concurrent/index.md","title":"\u300c\u8bb0\u300dJdk8 CompletableFuture\u5728\u9ad8\u5e76\u53d1\u73af\u5883\u4e0b\u7684\u6027\u80fd\u95ee\u9898","description":"\u6700\u8fd1\u7684\u5de5\u4f5c\u5185\u5bb9\u5c31\u662f\u5199\u4e00\u4e2a DualHBaseClient\uff0c\u5728\u67e5\u8be2\u6570\u636e\u65f6\u95f4\u8fc7\u957f\u65f6\uff0c\u80fd\u591f\u5c06\u540c\u6837\u7684\u8bf7\u6c42\u53d1\u7ed9 replication \u7684\u96c6\u7fa4\uff0c\u7f29\u5c0f client \u7aef\u7684 p99\u3001p999 \u5ef6\u8fdf\uff0c\u51cf\u5c0f\u6bdb\u523a\u3002","date":"2019-10-11T19:30:00.000Z","formattedDate":"2019\u5e7410\u670811\u65e5","tags":[{"label":"Jdk","permalink":"/blog/tags/jdk"},{"label":"Java","permalink":"/blog/tags/java"}],"readingTime":4.19,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"CompletableFuture-in-high-concurrent","title":"\u300c\u8bb0\u300dJdk8 CompletableFuture\u5728\u9ad8\u5e76\u53d1\u73af\u5883\u4e0b\u7684\u6027\u80fd\u95ee\u9898","date":"2019-10-11T19:30","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Jdk","Java"]},"prevItem":{"title":"\u521d\u6b65\u4e86\u89e3HBase Region Replicas","permalink":"/blog/Initial-Analysis-Region-Replicas"},"nextItem":{"title":"\u300c\u8bb0\u300d\u5b50\u7c7b\u590d\u5199\u7236\u7c7b\u65b9\u6cd5\u4e0e\u7c7b\u521d\u59cb\u5316\u987a\u5e8f\u5f15\u53d1\u7684bug","permalink":"/blog/class-init-order-in-inheritance"}},"content":"\u6700\u8fd1\u7684\u5de5\u4f5c\u5185\u5bb9\u5c31\u662f\u5199\u4e00\u4e2a `DualHBaseClient`\uff0c\u5728\u67e5\u8be2\u6570\u636e\u65f6\u95f4\u8fc7\u957f\u65f6\uff0c\u80fd\u591f\u5c06\u540c\u6837\u7684\u8bf7\u6c42\u53d1\u7ed9 replication \u7684\u96c6\u7fa4\uff0c\u7f29\u5c0f client \u7aef\u7684 p99\u3001p999 \u5ef6\u8fdf\uff0c\u51cf\u5c0f\u6bdb\u523a\u3002\\n\u5b9e\u9645\u5f00\u53d1\u6700\u521d\u7684\u4e00\u7248\u4ee3\u7801\u90fd\u6ca1\u6709\u82b1\u8d391pd\uff0c\u6027\u80fd\u6d4b\u8bd5\u5012\u6d4b\u4e86\u597d\u51e0\u5929\u90fd\u4e0d\u53ca\u9884\u671f\uff0c\u751a\u81f3\u4f18\u5316\u4e4b\u540e\u5404\u65b9\u9762\u6027\u80fd\u66f4\u5dee\u52b2\u3002\\n\\n\u672c\u6587\u5c31\u662f\u8bb0\u5f55\u4e0b\u5bfc\u81f4\u6b64\u6b21\u6027\u80fd\u95ee\u9898\u7684\u4e3b\u8981\u539f\u56e0\uff1aCompletableFuture.\\n\\n\u4f7f\u7528 Java \u5f02\u6b65\u7f16\u7a0b\u7684\u65f6\u5019\uff0c`CompletableFuture` \u7528\u8d77\u6765\u8fd8\u662f\u76f8\u5f53\u8212\u670d\u7684\uff0c\u5728HBase\u7684\u5f02\u6b65API\u91cc\uff0c\u4e5f\u5927\u91cf\u7684\u4f7f\u7528\u4e86`CompletableFuture`\uff0c\u5982\u679c `CompletableFuture` \u6709\u6027\u80fd\u95ee\u9898\uff0c\u90a3\u53ef\u5c31\u60b2\u50ac\u4e86\u3002\\n\\n\x3c!-- truncate --\x3e\\n\\n\u770b\u4e0b\u4ee5\u4e0b\u8fd9\u6bb5\u6d4b\u8bd5`CompletableFuture`\u7684\u4ee3\u7801\\n\\n```\\nimport com.google.common.collect.Lists;\\n\\nimport java.util.List;\\nimport java.util.concurrent.CompletableFuture;\\nimport java.util.concurrent.ExecutionException;\\n\\npublic class FutureTest {\\n\\n    public static void main(String[] args) throws ExecutionException, InterruptedException {\\n        new FutureTest().run();\\n    }\\n\\n    private void run() throws ExecutionException, InterruptedException {\\n        List<CompletableFuture> futures = Lists.newArrayList();\\n        for (int i = 0; i < 1000; i++) {\\n            CompletableFuture future = new CompletableFuture();\\n            CompletableFuture f = CompletableFuture.runAsync(this::read);\\n            f.whenComplete((r, e) -> future.complete(r));\\n            futures.add(future);\\n        }\\n        for (CompletableFuture future : futures) {\\n            future.get();\\n        }\\n    }\\n\\n    private void read() {\\n        try {\\n            Thread.sleep(100);\\n        } catch (InterruptedException e) {\\n            e.printStackTrace();\\n        }\\n    }\\n}\\n```\\n\\n\u4ee5\u4e0a\u8fd9\u6bb5\u4ee3\u7801\u5b9e\u9645\u53ea\u662f\u8ba9 `CompletableFuture` \u7a7a\u8f6c\uff0c\u9664\u4e86 sleep \u6ca1\u518d\u505a\u5176\u4ed6\u7684\uff0c\u5faa\u73af1000\u8ba9\u8fd0\u884c\u65f6\u95f4\u5c3d\u91cf\u957f\u4e00\u4e9b\uff0c\u8db3\u591f\u8ba9\u6211\u4eec\u8dd1\u4e00\u4e2a\u706b\u7130\u56fe\u51fa\u6765\u3002\\n\\n![\u706b\u7130\u56fe](./CompletableFuture-in-jdk8-traces.svg)\\n\\n\u706b\u7130\u56fe\u91cc\u6ce8\u610f\u5230\u6709\u4e2a\u6700\u5927\u7684\u5e73\u9876 `java.lang.Runtime.availableProcessors`\uff0c\u8be5\u65b9\u6cd5\u8017\u65f6\u6781\u5927\uff0c\u751a\u81f3\u8d85\u8fc7\u4e86 Thread.sleep\uff0c\u8fd9\u53ef\u4e0d\u6b63\u5e38\u5427\u3002\\n\\n\u968f\u540e\u6211\u4eec\u6d4b\u4e0b `java.lang.Runtime.availableProcessors()` \u65b9\u6cd5\u662f\u4e0d\u662f\u771f\u7684\u6162\u3002\\n\\n```\\nimport com.google.common.base.Stopwatch;\\nimport org.junit.Assert;\\nimport org.junit.Test;\\n\\nimport java.util.concurrent.TimeUnit;\\n\\npublic class AvailableProcessorsTest {\\n\\n    @Test\\n    public void test() {\\n        Stopwatch sw = Stopwatch.createStarted();\\n        for (int i = 0; i < 1000000; i++) {\\n            Runtime.getRuntime().availableProcessors();\\n        }\\n        Assert.assertTrue(sw.elapsed(TimeUnit.SECONDS) > 10);\\n    }\\n}\\n```\\n\\n\u5728\u6211\u7684\u673a\u5668\u4e0a\u5faa\u73af1000000\u6b21\uff0c\u8017\u65f6\u8d85\u8fc7\u4e8610s\uff0c\u4e0d\u7b97\u5feb\u3002\\n\\n\u518d\u6765\u770b\u770b `CompletableFuture` \u662f\u600e\u4e48\u4f7f\u7528 `Runtime.availableProcessors()` \u7684\\n\\n```\\nprivate Object waitingGet(boolean interruptible) {\\n    ...\\n    while ((r = result) == null) {\\n        if (spins < 0)\\n            spins = (Runtime.getRuntime().availableProcessors() > 1) ?\\n                1 << 8 : 0; // Use brief spin-wait on multiprocessors\\n        else if (spins > 0) {\\n            if (ThreadLocalRandom.nextSecondarySeed() >= 0)\\n                --spins;\\n        }\\n        ...\\n    }\\n    ...\\n}\\n```\\n\\nwhile \u6b7b\u5faa\u73af\u8981\u76f4\u5230\u51fa\u73b0\u5f02\u5e38\u6216\u83b7\u53d6\u5230\u6700\u7ec8\u7ed3\u679c\u624d\u4f1a\u7ed3\u675f\uff0c\u800c\u5faa\u73af\u4e2d\u53c8\u4f1a\u5927\u91cf\u8c03\u7528 `Runtime.availableProcessors()`\uff0c\u8fd9\u5c31\u662f`CompletableFuture`\u5b58\u5728\u7684\u6027\u80fd\u95ee\u9898\u3002\\n\\n\u800c\u5b9e\u9645\u4e0aOpenjdk\u5df2\u6709\u5bf9\u8be5\u95ee\u9898\u7684\u8ba8\u8bba\uff0c[JDK-8227018](https://bugs.openjdk.java.net/browse/JDK-8227018)\uff0c\u8be5\u4f18\u5316\u4e5f\u5f88\u7b80\u5355\uff0c\u5728\u8fd9\u91cc\u5176\u5b9e\u53ea\u662f\u9700\u8981\u77e5\u9053\u8fd0\u884c\u73af\u5883\u662f\u4e0d\u662f\u591a\u5904\u7406\u5668\u73af\u5883\u800c\u5df2\uff0c\u7f13\u5b58\u8d77\u6765\u5c31\u597d\uff0c\u5b8c\u5168\u6ca1\u5fc5\u8981\u6bcf\u6b21\u5faa\u73af\u90fd\u53bb\u83b7\u53d6\u3002\u5728jdk8u232\u7248\u672c\u5c31fix\u6389\u4e86\u3002\\n\\n\u800c\u4e14\u6211\u8fd8\u770b\u4e86 jdk11\u3001jdk13 \u7684\u5b9e\u73b0\uff0c\u90fd\u4e0d\u518d\u4f7f\u7528`Runtime.availableProcessors()`\u4e86\uff0c\u6240\u4ee5\u7b97\u662f\u4f4e\u7248\u672c jdk8 \u7528\u6237\u72ec\u6709\u7684\u70e6\u607c\u3002\\n\\n> \u4e00\u4e2a\u5c0f\u63d2\u66f2\\n> \\n> jdk8u232\u7248\u672c\u662f2019.10.15\u624d\u6b63\u5f0frelease\u7684\uff0c\u800c\u6211\u53d1\u73b0\u8fd9\u4e2a\u95ee\u9898\u662f\u572810.13\u3002\\n> \u4e5f\u5e78\u8fd0\u4e5f\u4e0d\u5e78\uff0c\u5e78\u8fd0\u7684\u662f\u8d77\u7801\u95ee\u9898fix\u6389\u4e86\uff0c\u4e0d\u5e78\u7684\u662f DualHBaseClient \u4e0d\u80fd\u91c7\u7528 CompletableFuture \u5b9e\u73b0\u4e86\uff0c\u603b\u4e0d\u597d\u8981\u6c42\u7528\u6237\u5347\u7ea7jdk\u5427\\n\\n\u77e5\u9053\u4f4e\u7248\u672c\u7684 jdk8 \u6709\u95ee\u9898\u4e4b\u540e\uff0c`DualHBaseClient` \u8fd8\u662f\u8981\u5199\u7684\uff0c\u53ea\u80fd\u5bfb\u6c42\u5176\u4ed6\u7684\u5f02\u6b65\u6846\u67b6\u6765\u5b9e\u73b0\uff0c\u597d\u5728 guava \u7684 `ListenableFuture` \u5b9e\u73b0\u5f88\u50cf`CompletableFuture`\u3002\\n\\n## \u603b\u7ed3\\n\\n\u5982\u679c\u662fjdk8\u4f4e\u7248\u672c\u7528\u6237\uff08\u521a\u53d1\u5e03\u51e0\u5929\u4e0d\u4f1a\u6709\u516c\u53f8\u5347\u7ea7\u5427\uff09\u9891\u7e41\u7684\u5927\u91cf\u4f7f\u7528 CompletableFuture\uff0c\u662f\u5b58\u5728\u6027\u80fd\u95ee\u9898\uff0c\u5347\u7ea7 jdk \u662f\u6700\u7b80\u5355\u7684\u529e\u6cd5\uff0c\u4f7f\u7528 guava \u7684 Future \u5e93\u5b9e\u73b0\u4e5f\u53ef\u4ee5\uff0c\u4f46\u53ef\u80fd\u8981\u5927\u91cf\u4fee\u6539\u4ee3\u7801\u4e86\u3002\\n\\n## \u9644\u5f55\\n\\n- [\u706b\u7130\u56fe\u6392\u67e5Java\u6027\u80fd\u95ee\u9898](https://blog.wangqi.love/articles/Java/%E7%81%AB%E7%84%B0%E5%9B%BE%E6%8E%92%E6%9F%A5Java%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98.html)\\n- [JDK-8227018](https://bugs.openjdk.java.net/browse/JDK-8227018)"},{"id":"class-init-order-in-inheritance","metadata":{"permalink":"/blog/class-init-order-in-inheritance","editUrl":"https://github.com/ddupg/ddupg.github.io/tree/main/blog/class-init-order-in-inheritance/index.md","source":"@site/blog/class-init-order-in-inheritance/index.md","title":"\u300c\u8bb0\u300d\u5b50\u7c7b\u590d\u5199\u7236\u7c7b\u65b9\u6cd5\u4e0e\u7c7b\u521d\u59cb\u5316\u987a\u5e8f\u5f15\u53d1\u7684bug","description":"bug\u73b0\u8c61","date":"2019-09-30T10:00:00.000Z","formattedDate":"2019\u5e749\u670830\u65e5","tags":[{"label":"Java","permalink":"/blog/tags/java"},{"label":"Bug","permalink":"/blog/tags/bug"}],"readingTime":3.57,"truncated":true,"authors":[{"name":"Ddupg","url":"https://ddupg.github.io"}],"frontMatter":{"slug":"class-init-order-in-inheritance","title":"\u300c\u8bb0\u300d\u5b50\u7c7b\u590d\u5199\u7236\u7c7b\u65b9\u6cd5\u4e0e\u7c7b\u521d\u59cb\u5316\u987a\u5e8f\u5f15\u53d1\u7684bug","date":"2019-09-30T10:00","author":"Ddupg","author_url":"https://ddupg.github.io","tags":["Java","Bug"]},"prevItem":{"title":"\u300c\u8bb0\u300dJdk8 CompletableFuture\u5728\u9ad8\u5e76\u53d1\u73af\u5883\u4e0b\u7684\u6027\u80fd\u95ee\u9898","permalink":"/blog/CompletableFuture-in-high-concurrent"}},"content":"\x3c!-- truncate --\x3e\\n\\n\\n## bug\u73b0\u8c61\\nbug\u51fa\u73b0\u7684\u6761\u4ef6\uff1a\\n- \u7ee7\u627f\u5173\u7cfb\\n- \u5b50\u7c7b\u5c5e\u6027\u6709\u9ed8\u8ba4\u7684\u521d\u59cb\u5316\\n- \u5b50\u7c7b\u590d\u5199\u4e86\u7236\u7c7b\u7684\u94a9\u5b50\u65b9\u6cd5\\n- \u94a9\u5b50\u65b9\u6cd5\u5728\u7236\u7c7b\u6784\u9020\u65b9\u6cd5\u4e2d\u8c03\u7528\\n\\n\u53ef\u4ee5\u770b\u4e0b\u4ee5\u4e0b\u7684\u793a\u4f8b\u4ee3\u7801\\n\\n```\\npublic class Father {\\n\\n    public Father() {\\n        init();\\n    }\\n\\n    protected void init() {\\n    }\\n}\\n```\\n\\n```\\npublic class Child extends Father {\\n\\n    int a = 0;\\n\\n    public Child() {\\n        super();\\n    }\\n\\n    @Override\\n    protected void init() {\\n        super.init();\\n        a = 1;\\n    }\\n}\\n```\\n\\n```\\nimport org.junit.Test;\\n\\nimport static org.junit.Assert.*;\\n\\npublic class ChildTest {\\n\\n    @Test\\n    public void testConstructor() {\\n        Child child = new Child();\\n        assertEquals(0, child.a);\\n    }\\n}\\n```\\n\\n## \u7c7b\u52a0\u8f7d\u8fc7\u7a0b\\n\u987a\u4fbf\u590d\u4e60\u4e00\u4e0b\u7c7b\u52a0\u8f7d\u8fc7\u7a0b\uff0c\u7c7b\u52a0\u8f7d\u8fc7\u7a0b\u5206\u4e3a\u52a0\u8f7d\u3001\u94fe\u63a5\u3001\u521d\u59cb\u5316\u4e09\u5927\u6b65\u9aa4\\n\\n\u52a0\u8f7d\uff1a\u67e5\u627e\u5e76\u52a0\u8f7d\u7c7b\u7684\u4e8c\u8fdb\u5236\u5b57\u8282\u6d41\u6570\u636e\uff0c\u5e76\u4e14\u636e\u6b64\u521b\u5efa\u7c7b\uff0c\u5373\u4ee3\u8868\u8fd9\u4e2a\u7c7b\u7684Class\u5bf9\u8c61\u3002\\n\\n\u94fe\u63a5\uff1a\u5c06\u521b\u5efa\u6210\u7684\u7c7b\u5408\u5e76\u81f3Java\u865a\u62df\u673a\u4e2d\uff0c\u4f7f\u4e4b\u80fd\u591f\u6267\u884c\u7684\u8fc7\u7a0b\u3002\u8fd8\u5206\u9a8c\u8bc1\u3001\u51c6\u5907\u3001\u89e3\u6790\u4e09\u4e2a\u9636\u6bb5\u3002\\n- \u9a8c\u8bc1\uff1a\u786e\u4fdd\u88ab\u52a0\u8f7d\u7c7b\u7684\u6b63\u786e\u6027\\n- \u51c6\u5907\uff1a\u4e3a\u7c7b\u7684\u9759\u6001\u53d8\u91cf\u5206\u914d\u5185\u5b58\uff0c\u5e76\u5c06\u5176\u521d\u59cb\u5316\u4e3a\u9ed8\u8ba4\u503c\\n- \u89e3\u6790\uff1a\u628a\u7c7b\u4e2d\u7684\u7b26\u53f7\u5f15\u7528\u8f6c\u6362\u4e3a\u76f4\u63a5\u5f15\u7528\\n\\n\u521d\u59cb\u5316\uff1a\u6807\u8bb0\u4e3a\u5e38\u91cf\u503c\u7684\u5b57\u6bb5\u8d4b\u503c\uff0c\u4ee5\u53ca\u6267\u884c\u65b9\u6cd5\u3002\u521d\u59cb\u5316\u7684\u65f6\u673a\uff1a\\n1. \u865a\u62df\u673a\u542f\u52a8\u65f6\uff0c\u521d\u59cb\u5316\u7528\u6237\u6307\u5b9a\u7684\u4e3b\u7c7b\\n2. \u5f53\u9047\u5230\u4ee5\u65b0\u5efa\u76ee\u6807\u7c7b\u5b9e\u4f8b\u7684new\u6307\u4ee4\u65f6\uff0c\u521d\u59cb\u5316new\u6307\u5b9a\u7684\u76ee\u6807\u7c7b\\n3. \u5f53\u9047\u5230\u8c03\u7528\u9759\u6001\u65b9\u6cd5\u7684\u6307\u4ee4\u5b57\u6bb5\u662f\uff0c\u521d\u59cb\u5316\u8be5\u9759\u6001\u65b9\u6cd5\u6240\u5728\u7684\u7c7b\\n4. \u5f53\u9047\u5230\u8bbf\u95ee\u9759\u6001\u5b57\u6bb5\u7684\u6307\u4ee4\u65f6\uff0c\u521d\u59cb\u5316\u8be5\u9759\u6001\u5b57\u6bb5\u6240\u5728\u7684\u7c7b\\n5. \u5b50\u7c7b\u7684\u521d\u59cb\u5316\u4f1a\u89e6\u53d1\u7236\u7c7b\u7684\u521d\u59cb\u5316\\n6. \u5982\u679c\u4e00\u4e2a\u63a5\u53e3\u5b9a\u4e49\u4e86default\u65b9\u6cd5\uff0c\u90a3\u4e48\u76f4\u63a5\u6216\u95f4\u63a5\u5b9e\u73b0\u8be5\u63a5\u53e3\u7684\u7c7b\u521d\u59cb\u5316\uff0c\u4f1a\u89e6\\n7. \u8be5\u63a5\u53e3\u7684\u521d\u59cb\u5316\\n8. \u4f7f\u7528\u53cd\u5c04API\u5bf9\u67d0\u4e2a\u7c7b\u8fdb\u884c\u53cd\u5c04\u8c03\u7528\u65f6\uff0c\u521d\u59cb\u5316\u8fd9\u4e2a\u7c7b\\n9. \u5f53\u521d\u6b21\u8c03\u7528MethodHandle\u5b9e\u4f8b\u65f6\uff0c\u521d\u59cb\u5316\u8be5MethodHandle\u6307\u5411\u7684\u65b9\u6cd5\u6240\u5728\u7684\u7c7b\\n\\n## \u7c7b\u521d\u59cb\u5316\u987a\u5e8f\\n\\n1. \u6309\u5b9a\u4e49\u987a\u5e8f\u521d\u59cb\u5316\u7236\u7c7b\u7684static\u6210\u5458\uff0c\u5728\u51c6\u5907\u9636\u6bb5\u5b8c\u6210\\n2. \u6309\u5b9a\u4e49\u987a\u5e8f\u521d\u59cb\u5316\u5b50\u7c7b\u7684static\u6210\u5458\uff0c\u5728\u51c6\u5907\u9636\u6bb5\u5b8c\u6210\\n3. \u6309\u5b9a\u4e49\u987a\u5e8f\u6267\u884c\u7236\u7c7b\u7684\u666e\u901a\u6210\u5458\u521d\u59cb\u5316\\n4. \u6267\u884c\u7236\u7c7b\u7684\u6784\u9020\u51fd\u6570\\n5. \u6309\u5b9a\u4e49\u987a\u5e8f\u6267\u884c\u5b50\u7c7b\u7684\u6307\u5b9a\u521d\u59cb\u5316\\n6. \u6267\u884c\u5b50\u7c7b\u7684\u6784\u9020\u51fd\u6570\\n\\n## \u56de\u5934\u89e3bug\\n\\n\u73b0\u5728\u518d\u56de\u5934\u770b\u4e0bbug\u4ee3\u7801\u5c31\u77e5\u9053\u662f\u4ec0\u4e48\u539f\u56e0\uff1a\u7236\u7c7b\u6267\u884c\u6784\u9020\u65b9\u6cd5\u65f6\u8c03\u7528\u4e86\u4f1a\u4fee\u6539\u5b50\u7c7b\u6210\u5458`a`\u7684\u94a9\u5b50\u65b9\u6cd5\uff0c\u7136\u540e\u5b50\u7c7b\u624d\u521d\u59cb\u5316\u4e86\u81ea\u5df1\u7684\u6210\u5458\uff0c\u8986\u76d6\u4e86\u94a9\u5b50\u65b9\u6cd5\u91cc\u5bf9`a`\u7684\u4fee\u6539\u3002\\n\\n\u89e3\u51b3\u65b9\u6cd5\u4e5f\u7b80\u5355\uff0c\u5bf9`a`\u4e0d\u52a0\u9ed8\u8ba4\u503c\u5c31\u597d\u4e86\u3002"}]}')}}]);